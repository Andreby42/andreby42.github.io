<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Mybatis,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1">






<meta name="description" content="Mybatis源码分析二">
<meta name="keywords" content="Mybatis">
<meta property="og:type" content="article">
<meta property="og:title" content="Mybatis源码分析(二)">
<meta property="og:url" content="http://yoursite.com/2018/11/07/Mybatis源码分析-二/index.html">
<meta property="og:site_name" content="Andreby的随记">
<meta property="og:description" content="Mybatis源码分析二">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-01-22T11:07:38.381Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mybatis源码分析(二)">
<meta name="twitter:description" content="Mybatis源码分析二">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/11/07/Mybatis源码分析-二/">





  <title>Mybatis源码分析(二) | Andreby的随记</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Andreby的随记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">如果有什么需要明天做的事 最好现在开始做</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/07/Mybatis源码分析-二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Andreby">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/p829173265.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Andreby的随记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Mybatis源码分析(二)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-07T18:22:20+08:00">
                2018-11-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">Mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Mybatis源码分析二<a id="more"></a></p>
<p><strong>基于3.4.5版本。与springboot2.0.5 mybatis-spring1.3.2</strong></p>
<ul>
<li><p>主要的核心类</p>
<ul>
<li><strong>Configuration: MyBatis 所有的配置信息都维持在 Configuration 对象之中。</strong></li>
<li><strong>SqlSession :作为 MyBatis 工作的主要顶层 API，表示和数据库交互的会话，完成必要数据库增删改查功能</strong></li>
<li><strong>Executor :MyBatis 执行器，是 MyBatis 调度的核心，负责 SQL 语句的生成和查询缓存的维护</strong></li>
<li><strong>StatementHandler :封装了 JDBC Statement 操作，负责对 JDBC statement 的操作，如设置参数、将 Statement 结果集转换成 List 集合。</strong></li>
<li>*<em>ParameterHandler :负责对用户传递的参数转换成 JDBC Statement 所需要的参数 *</em></li>
<li><strong>ResultSetHandler :负责将 JDBC 返回的 ResultSet 结果集对象转换成 List 类型的集合</strong></li>
<li><strong>TypeHandler:负责 java 数据类型和 jdbc 数据类型之间的映射和转换</strong></li>
<li><strong>MappedStatement :MappedStatement 维护了一条 &lt;select|update|delete|insert&gt; 节点的封装</strong></li>
<li><strong>SqlSource :负责根据用户传递的 parameterObject，动态地生成 SQL 语句，将信息封装到 BoundSql 对象中并返回</strong></li>
<li><strong>BoundSql :表示动态生成的 SQL 语句以及相应的参数信息</strong></li>
</ul>
</li>
<li><p><strong>Mybatis启动过程</strong></p>
<p><strong>这个类是个建造者 会创建sqlsessionFactory,提供了挺多的build方法。</strong></p>
<p>上源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">public class SqlSessionFactoryBuilder &#123;</span><br><span class="line">...</span><br><span class="line"> public SqlSessionFactory build(Reader reader) &#123;</span><br><span class="line">    return build(reader, null, null);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public SqlSessionFactory build(Reader reader, String environment) &#123;</span><br><span class="line">    return build(reader, environment, null);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public SqlSessionFactory build(Reader reader, Properties properties) &#123;</span><br><span class="line">    return build(reader, null, properties);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public SqlSessionFactory build(Reader reader, String environment, Properties properties) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      XMLConfigBuilder parser = new XMLConfigBuilder(reader, environment, properties);</span><br><span class="line">      //注意这里的parser.parse();</span><br><span class="line">      return build(parser.parse());</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      //重置错误上下文实例</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">      try &#123;</span><br><span class="line">        reader.close();</span><br><span class="line">      &#125; catch (IOException e) &#123;</span><br><span class="line">        // Intentionally ignore. Prefer previous error.</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  //parse方法</span><br><span class="line">  public Configuration parse() &#123;</span><br><span class="line">    if (parsed) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Each XMLConfigBuilder can only be used once.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    parsed = true;</span><br><span class="line">    parseConfiguration(parser.evalNode(&quot;/configuration&quot;));</span><br><span class="line">    return configuration;</span><br><span class="line">  &#125;</span><br><span class="line"> //具体的解析</span><br><span class="line">  private void parseConfiguration(XNode root) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      //issue #117 read properties first</span><br><span class="line">      // 解析&lt;properties&gt;节点</span><br><span class="line">      propertiesElement(root.evalNode(&quot;properties&quot;));</span><br><span class="line">      //解析settings节点</span><br><span class="line">      Properties settings = settingsAsProperties(root.evalNode(&quot;settings&quot;));</span><br><span class="line">      //加载自定义的settings</span><br><span class="line">      loadCustomVfs(settings);</span><br><span class="line">      /// 解析&lt;typeAliases&gt;节点</span><br><span class="line">      typeAliasesElement(root.evalNode(&quot;typeAliases&quot;));</span><br><span class="line">      // 解析&lt;plugins&gt;节点</span><br><span class="line">      pluginElement(root.evalNode(&quot;plugins&quot;));</span><br><span class="line">      // 解析&lt;objectFactory&gt;节点</span><br><span class="line">      objectFactoryElement(root.evalNode(&quot;objectFactory&quot;));</span><br><span class="line">      objectWrapperFactoryElement(root.evalNode(&quot;objectWrapperFactory&quot;));</span><br><span class="line">      // 解析&lt;reflectorFactory&gt;节点</span><br><span class="line">      reflectorFactoryElement(root.evalNode(&quot;reflectorFactory&quot;));</span><br><span class="line">      settingsElement(settings);</span><br><span class="line">       // 解析&lt;environments&gt;节点</span><br><span class="line">      // read it after objectFactory and objectWrapperFactory issue #631</span><br><span class="line">      environmentsElement(root.evalNode(&quot;environments&quot;));</span><br><span class="line">      //多数据源的话解析dbid</span><br><span class="line">      databaseIdProviderElement(root.evalNode(&quot;databaseIdProvider&quot;));</span><br><span class="line">      typeHandlerElement(root.evalNode(&quot;typeHandlers&quot;));</span><br><span class="line">       // 解析&lt;mappers&gt;节点</span><br><span class="line">      mapperElement(root.evalNode(&quot;mappers&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing SQL Mapper Configuration. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public SqlSessionFactory build(InputStream inputStream) &#123;</span><br><span class="line">    return build(inputStream, null, null);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public SqlSessionFactory build(InputStream inputStream, String environment) &#123;</span><br><span class="line">    return build(inputStream, environment, null);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public SqlSessionFactory build(InputStream inputStream, Properties properties) &#123;</span><br><span class="line">    return build(inputStream, null, properties);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">      return build(parser.parse());</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">      try &#123;</span><br><span class="line">        inputStream.close();</span><br><span class="line">      &#125; catch (IOException e) &#123;</span><br><span class="line">        // Intentionally ignore. Prefer previous error.</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>在项目启动的适合，我这里用的springboot集成的项目当然配置文件是写在application.properties的，springmvc项目一般在xml文件中配置的</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">mybatis.type-aliases-package=com.convergence.domain</span><br><span class="line">mybatis.mapper-locations=classpath:/mapper/*.xml</span><br><span class="line">mybatis.config-location=</span><br><span class="line">mybatis.configuration.map-underscore-to-camel-case=true</span><br><span class="line">mybatis.configuration.multiple-result-sets-enabled=true</span><br><span class="line">mybatis.configuration.useColumnLabel=true</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>创建factory</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class SqlSessionFactoryBuilder &#123;</span><br><span class="line">...</span><br><span class="line">public SqlSessionFactory build(Configuration config) &#123;</span><br><span class="line">  return new DefaultSqlSessionFactory(config);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Configuration类记录了mybatis的一些配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *    Copyright 2009-2017 the original author or authors.</span><br><span class="line"> *</span><br><span class="line"> *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> *    you may not use this file except in compliance with the License.</span><br><span class="line"> *    You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *       http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> *    Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> *    See the License for the specific language governing permissions and</span><br><span class="line"> *    limitations under the License.</span><br><span class="line"> */</span><br><span class="line">package org.apache.ibatis.session;</span><br><span class="line"></span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.HashSet;</span><br><span class="line">import java.util.LinkedList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Properties;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">import org.apache.ibatis.binding.MapperRegistry;</span><br><span class="line">import org.apache.ibatis.builder.CacheRefResolver;</span><br><span class="line">import org.apache.ibatis.builder.ResultMapResolver;</span><br><span class="line">import org.apache.ibatis.builder.annotation.MethodResolver;</span><br><span class="line">import org.apache.ibatis.builder.xml.XMLStatementBuilder;</span><br><span class="line">import org.apache.ibatis.cache.Cache;</span><br><span class="line">import org.apache.ibatis.cache.decorators.FifoCache;</span><br><span class="line">import org.apache.ibatis.cache.decorators.LruCache;</span><br><span class="line">import org.apache.ibatis.cache.decorators.SoftCache;</span><br><span class="line">import org.apache.ibatis.cache.decorators.WeakCache;</span><br><span class="line">import org.apache.ibatis.cache.impl.PerpetualCache;</span><br><span class="line">import org.apache.ibatis.datasource.jndi.JndiDataSourceFactory;</span><br><span class="line">import org.apache.ibatis.datasource.pooled.PooledDataSourceFactory;</span><br><span class="line">import org.apache.ibatis.datasource.unpooled.UnpooledDataSourceFactory;</span><br><span class="line">import org.apache.ibatis.executor.BatchExecutor;</span><br><span class="line">import org.apache.ibatis.executor.CachingExecutor;</span><br><span class="line">import org.apache.ibatis.executor.Executor;</span><br><span class="line">import org.apache.ibatis.executor.ReuseExecutor;</span><br><span class="line">import org.apache.ibatis.executor.SimpleExecutor;</span><br><span class="line">import org.apache.ibatis.executor.keygen.KeyGenerator;</span><br><span class="line">import org.apache.ibatis.executor.loader.ProxyFactory;</span><br><span class="line">import org.apache.ibatis.executor.loader.cglib.CglibProxyFactory;</span><br><span class="line">import org.apache.ibatis.executor.loader.javassist.JavassistProxyFactory;</span><br><span class="line">import org.apache.ibatis.executor.parameter.ParameterHandler;</span><br><span class="line">import org.apache.ibatis.executor.resultset.DefaultResultSetHandler;</span><br><span class="line">import org.apache.ibatis.executor.resultset.ResultSetHandler;</span><br><span class="line">import org.apache.ibatis.executor.statement.RoutingStatementHandler;</span><br><span class="line">import org.apache.ibatis.executor.statement.StatementHandler;</span><br><span class="line">import org.apache.ibatis.io.VFS;</span><br><span class="line">import org.apache.ibatis.logging.Log;</span><br><span class="line">import org.apache.ibatis.logging.LogFactory;</span><br><span class="line">import org.apache.ibatis.logging.commons.JakartaCommonsLoggingImpl;</span><br><span class="line">import org.apache.ibatis.logging.jdk14.Jdk14LoggingImpl;</span><br><span class="line">import org.apache.ibatis.logging.log4j.Log4jImpl;</span><br><span class="line">import org.apache.ibatis.logging.log4j2.Log4j2Impl;</span><br><span class="line">import org.apache.ibatis.logging.nologging.NoLoggingImpl;</span><br><span class="line">import org.apache.ibatis.logging.slf4j.Slf4jImpl;</span><br><span class="line">import org.apache.ibatis.logging.stdout.StdOutImpl;</span><br><span class="line">import org.apache.ibatis.mapping.BoundSql;</span><br><span class="line">import org.apache.ibatis.mapping.Environment;</span><br><span class="line">import org.apache.ibatis.mapping.MappedStatement;</span><br><span class="line">import org.apache.ibatis.mapping.ParameterMap;</span><br><span class="line">import org.apache.ibatis.mapping.ResultMap;</span><br><span class="line">import org.apache.ibatis.mapping.VendorDatabaseIdProvider;</span><br><span class="line">import org.apache.ibatis.parsing.XNode;</span><br><span class="line">import org.apache.ibatis.plugin.Interceptor;</span><br><span class="line">import org.apache.ibatis.plugin.InterceptorChain;</span><br><span class="line">import org.apache.ibatis.reflection.DefaultReflectorFactory;</span><br><span class="line">import org.apache.ibatis.reflection.MetaObject;</span><br><span class="line">import org.apache.ibatis.reflection.ReflectorFactory;</span><br><span class="line">import org.apache.ibatis.reflection.factory.DefaultObjectFactory;</span><br><span class="line">import org.apache.ibatis.reflection.factory.ObjectFactory;</span><br><span class="line">import org.apache.ibatis.reflection.wrapper.DefaultObjectWrapperFactory;</span><br><span class="line">import org.apache.ibatis.reflection.wrapper.ObjectWrapperFactory;</span><br><span class="line">import org.apache.ibatis.scripting.LanguageDriver;</span><br><span class="line">import org.apache.ibatis.scripting.LanguageDriverRegistry;</span><br><span class="line">import org.apache.ibatis.scripting.defaults.RawLanguageDriver;</span><br><span class="line">import org.apache.ibatis.scripting.xmltags.XMLLanguageDriver;</span><br><span class="line">import org.apache.ibatis.transaction.Transaction;</span><br><span class="line">import org.apache.ibatis.transaction.jdbc.JdbcTransactionFactory;</span><br><span class="line">import org.apache.ibatis.transaction.managed.ManagedTransactionFactory;</span><br><span class="line">import org.apache.ibatis.type.JdbcType;</span><br><span class="line">import org.apache.ibatis.type.TypeAliasRegistry;</span><br><span class="line">import org.apache.ibatis.type.TypeHandler;</span><br><span class="line">import org.apache.ibatis.type.TypeHandlerRegistry;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Clinton Begin</span><br><span class="line"> */</span><br><span class="line">public class Configuration &#123;</span><br><span class="line">  //上下文环境对象</span><br><span class="line">  protected Environment environment;</span><br><span class="line"></span><br><span class="line">  protected boolean safeRowBoundsEnabled;</span><br><span class="line">  protected boolean safeResultHandlerEnabled = true;</span><br><span class="line">  protected boolean mapUnderscoreToCamelCase;</span><br><span class="line">  //当启用时，有延迟加载属性的对象在被调用时将会完全加载任意属性。否则，每种属性将会按需要加载</span><br><span class="line">  protected boolean aggressiveLazyLoading;</span><br><span class="line">  //允许或不允许多种结果集从一个单独的语句中返回（需要适合的驱动）。</span><br><span class="line">  protected boolean multipleResultSetsEnabled = true;</span><br><span class="line">  //允许 JDBC 支持生成的键。需要适合的驱动。如果设置为 true 则这个设置强制生成的键被使用，尽管一些	//驱动拒绝兼容但仍然有效（比如 Derby</span><br><span class="line">  protected boolean useGeneratedKeys;</span><br><span class="line">  //使用列标签代替列名。不同的驱动在这方便表现不同。参考驱动文档或充分测试两种方法来决定所使用的驱动</span><br><span class="line">  protected boolean useColumnLabel = true;</span><br><span class="line">  //是否全局启用缓存 默认开启</span><br><span class="line">  protected boolean cacheEnabled = true;</span><br><span class="line">  protected boolean callSettersOnNulls;</span><br><span class="line">  protected boolean useActualParamName = true;</span><br><span class="line">  protected boolean returnInstanceForEmptyRow;</span><br><span class="line"></span><br><span class="line">  protected String logPrefix;</span><br><span class="line">  protected Class &lt;? extends Log&gt; logImpl;</span><br><span class="line">  protected Class &lt;? extends VFS&gt; vfsImpl;</span><br><span class="line">  protected LocalCacheScope localCacheScope = LocalCacheScope.SESSION;</span><br><span class="line">  protected JdbcType jdbcTypeForNull = JdbcType.OTHER;</span><br><span class="line">  protected Set&lt;String&gt; lazyLoadTriggerMethods = new HashSet&lt;String&gt;(Arrays.asList(new String[] &#123; &quot;equals&quot;, &quot;clone&quot;, &quot;hashCode&quot;, &quot;toString&quot; &#125;));</span><br><span class="line">  protected Integer defaultStatementTimeout;</span><br><span class="line">  protected Integer defaultFetchSize;</span><br><span class="line">  protected ExecutorType defaultExecutorType = ExecutorType.SIMPLE;</span><br><span class="line">  //指定 MyBatis 如何自动映射列到字段 / 属性。PARTIAL 只会自动映射简单，没有嵌套的结果。FULL 会自//动映射任意复杂的结果（嵌套的或其他情况）。</span><br><span class="line">  protected AutoMappingBehavior autoMappingBehavior = AutoMappingBehavior.PARTIAL;</span><br><span class="line">  protected AutoMappingUnknownColumnBehavior autoMappingUnknownColumnBehavior = AutoMappingUnknownColumnBehavior.NONE;</span><br><span class="line"></span><br><span class="line">  protected Properties variables = new Properties();</span><br><span class="line">  protected ReflectorFactory reflectorFactory = new DefaultReflectorFactory();</span><br><span class="line">  protected ObjectFactory objectFactory = new DefaultObjectFactory();</span><br><span class="line">  protected ObjectWrapperFactory objectWrapperFactory = new DefaultObjectWrapperFactory();</span><br><span class="line">  //全局是否启用活禁用懒加载，默认关闭 </span><br><span class="line">  protected boolean lazyLoadingEnabled = false;</span><br><span class="line">  protected ProxyFactory proxyFactory = new JavassistProxyFactory(); // #224 Using internal Javassist instead of OGNL</span><br><span class="line"></span><br><span class="line">  protected String databaseId;</span><br><span class="line">  /**</span><br><span class="line">   * Configuration factory class.</span><br><span class="line">   * Used to create Configuration for loading deserialized unread properties.</span><br><span class="line">   *</span><br><span class="line">   * @see &lt;a href=&apos;https://code.google.com/p/mybatis/issues/detail?id=300&apos;&gt;Issue 300 (google code)&lt;/a&gt;</span><br><span class="line">   */</span><br><span class="line">  protected Class&lt;?&gt; configurationFactory;</span><br><span class="line"></span><br><span class="line">  protected final MapperRegistry mapperRegistry = new MapperRegistry(this);</span><br><span class="line">  protected final InterceptorChain interceptorChain = new InterceptorChain();</span><br><span class="line">  protected final TypeHandlerRegistry typeHandlerRegistry = new TypeHandlerRegistry();</span><br><span class="line">  protected final TypeAliasRegistry typeAliasRegistry = new TypeAliasRegistry();</span><br><span class="line">  protected final LanguageDriverRegistry languageRegistry = new LanguageDriverRegistry();</span><br><span class="line"></span><br><span class="line">  protected final Map&lt;String, MappedStatement&gt; mappedStatements = new StrictMap&lt;MappedStatement&gt;(&quot;Mapped Statements collection&quot;);</span><br><span class="line">  protected final Map&lt;String, Cache&gt; caches = new StrictMap&lt;Cache&gt;(&quot;Caches collection&quot;);</span><br><span class="line">  protected final Map&lt;String, ResultMap&gt; resultMaps = new StrictMap&lt;ResultMap&gt;(&quot;Result Maps collection&quot;);</span><br><span class="line">  protected final Map&lt;String, ParameterMap&gt; parameterMaps = new StrictMap&lt;ParameterMap&gt;(&quot;Parameter Maps collection&quot;);</span><br><span class="line">  protected final Map&lt;String, KeyGenerator&gt; keyGenerators = new StrictMap&lt;KeyGenerator&gt;(&quot;Key Generators collection&quot;);</span><br><span class="line"></span><br><span class="line">  protected final Set&lt;String&gt; loadedResources = new HashSet&lt;String&gt;();</span><br><span class="line">  protected final Map&lt;String, XNode&gt; sqlFragments = new StrictMap&lt;XNode&gt;(&quot;XML fragments parsed from previous mappers&quot;);</span><br><span class="line"></span><br><span class="line">  protected final Collection&lt;XMLStatementBuilder&gt; incompleteStatements = new LinkedList&lt;XMLStatementBuilder&gt;();</span><br><span class="line">  protected final Collection&lt;CacheRefResolver&gt; incompleteCacheRefs = new LinkedList&lt;CacheRefResolver&gt;();</span><br><span class="line">  protected final Collection&lt;ResultMapResolver&gt; incompleteResultMaps = new LinkedList&lt;ResultMapResolver&gt;();</span><br><span class="line">  protected final Collection&lt;MethodResolver&gt; incompleteMethods = new LinkedList&lt;MethodResolver&gt;();</span><br><span class="line"></span><br><span class="line">  /*</span><br><span class="line">   * A map holds cache-ref relationship. The key is the namespace that</span><br><span class="line">   * references a cache bound to another namespace and the value is the</span><br><span class="line">   * namespace which the actual cache is bound to.</span><br><span class="line">   */</span><br><span class="line">  protected final Map&lt;String, String&gt; cacheRefMap = new HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">  public Configuration(Environment environment) &#123;</span><br><span class="line">    this();</span><br><span class="line">    this.environment = environment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Configuration() &#123;</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;JDBC&quot;, JdbcTransactionFactory.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;MANAGED&quot;, ManagedTransactionFactory.class);</span><br><span class="line"></span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;JNDI&quot;, JndiDataSourceFactory.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;POOLED&quot;, PooledDataSourceFactory.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;UNPOOLED&quot;, UnpooledDataSourceFactory.class);</span><br><span class="line"></span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;PERPETUAL&quot;, PerpetualCache.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;FIFO&quot;, FifoCache.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;LRU&quot;, LruCache.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;SOFT&quot;, SoftCache.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;WEAK&quot;, WeakCache.class);</span><br><span class="line"></span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;DB_VENDOR&quot;, VendorDatabaseIdProvider.class);</span><br><span class="line"></span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;XML&quot;, XMLLanguageDriver.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;RAW&quot;, RawLanguageDriver.class);</span><br><span class="line"></span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;SLF4J&quot;, Slf4jImpl.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;COMMONS_LOGGING&quot;, JakartaCommonsLoggingImpl.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;LOG4J&quot;, Log4jImpl.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;LOG4J2&quot;, Log4j2Impl.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;JDK_LOGGING&quot;, Jdk14LoggingImpl.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;STDOUT_LOGGING&quot;, StdOutImpl.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;NO_LOGGING&quot;, NoLoggingImpl.class);</span><br><span class="line"></span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;CGLIB&quot;, CglibProxyFactory.class);</span><br><span class="line">    typeAliasRegistry.registerAlias(&quot;JAVASSIST&quot;, JavassistProxyFactory.class);</span><br><span class="line"></span><br><span class="line">    languageRegistry.setDefaultDriverClass(XMLLanguageDriver.class);</span><br><span class="line">    languageRegistry.register(RawLanguageDriver.class);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public String getLogPrefix() &#123;</span><br><span class="line">    return logPrefix;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setLogPrefix(String logPrefix) &#123;</span><br><span class="line">    this.logPrefix = logPrefix;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Class&lt;? extends Log&gt; getLogImpl() &#123;</span><br><span class="line">    return logImpl;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setLogImpl(Class&lt;? extends Log&gt; logImpl) &#123;</span><br><span class="line">    if (logImpl != null) &#123;</span><br><span class="line">      this.logImpl = logImpl;</span><br><span class="line">      LogFactory.useCustomLogging(this.logImpl);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Class&lt;? extends VFS&gt; getVfsImpl() &#123;</span><br><span class="line">    return this.vfsImpl;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setVfsImpl(Class&lt;? extends VFS&gt; vfsImpl) &#123;</span><br><span class="line">    if (vfsImpl != null) &#123;</span><br><span class="line">      this.vfsImpl = vfsImpl;</span><br><span class="line">      VFS.addImplClass(this.vfsImpl);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isCallSettersOnNulls() &#123;</span><br><span class="line">    return callSettersOnNulls;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setCallSettersOnNulls(boolean callSettersOnNulls) &#123;</span><br><span class="line">    this.callSettersOnNulls = callSettersOnNulls;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isUseActualParamName() &#123;</span><br><span class="line">    return useActualParamName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setUseActualParamName(boolean useActualParamName) &#123;</span><br><span class="line">    this.useActualParamName = useActualParamName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isReturnInstanceForEmptyRow() &#123;</span><br><span class="line">    return returnInstanceForEmptyRow;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setReturnInstanceForEmptyRow(boolean returnEmptyInstance) &#123;</span><br><span class="line">    this.returnInstanceForEmptyRow = returnEmptyInstance;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public String getDatabaseId() &#123;</span><br><span class="line">    return databaseId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setDatabaseId(String databaseId) &#123;</span><br><span class="line">    this.databaseId = databaseId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Class&lt;?&gt; getConfigurationFactory() &#123;</span><br><span class="line">    return configurationFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setConfigurationFactory(Class&lt;?&gt; configurationFactory) &#123;</span><br><span class="line">    this.configurationFactory = configurationFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isSafeResultHandlerEnabled() &#123;</span><br><span class="line">    return safeResultHandlerEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setSafeResultHandlerEnabled(boolean safeResultHandlerEnabled) &#123;</span><br><span class="line">    this.safeResultHandlerEnabled = safeResultHandlerEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isSafeRowBoundsEnabled() &#123;</span><br><span class="line">    return safeRowBoundsEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setSafeRowBoundsEnabled(boolean safeRowBoundsEnabled) &#123;</span><br><span class="line">    this.safeRowBoundsEnabled = safeRowBoundsEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isMapUnderscoreToCamelCase() &#123;</span><br><span class="line">    return mapUnderscoreToCamelCase;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setMapUnderscoreToCamelCase(boolean mapUnderscoreToCamelCase) &#123;</span><br><span class="line">    this.mapUnderscoreToCamelCase = mapUnderscoreToCamelCase;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addLoadedResource(String resource) &#123;</span><br><span class="line">    loadedResources.add(resource);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isResourceLoaded(String resource) &#123;</span><br><span class="line">    return loadedResources.contains(resource);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Environment getEnvironment() &#123;</span><br><span class="line">    return environment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setEnvironment(Environment environment) &#123;</span><br><span class="line">    this.environment = environment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public AutoMappingBehavior getAutoMappingBehavior() &#123;</span><br><span class="line">    return autoMappingBehavior;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setAutoMappingBehavior(AutoMappingBehavior autoMappingBehavior) &#123;</span><br><span class="line">    this.autoMappingBehavior = autoMappingBehavior;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @since 3.4.0</span><br><span class="line">   */</span><br><span class="line">  public AutoMappingUnknownColumnBehavior getAutoMappingUnknownColumnBehavior() &#123;</span><br><span class="line">    return autoMappingUnknownColumnBehavior;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @since 3.4.0</span><br><span class="line">   */</span><br><span class="line">  public void setAutoMappingUnknownColumnBehavior(AutoMappingUnknownColumnBehavior autoMappingUnknownColumnBehavior) &#123;</span><br><span class="line">    this.autoMappingUnknownColumnBehavior = autoMappingUnknownColumnBehavior;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isLazyLoadingEnabled() &#123;</span><br><span class="line">    return lazyLoadingEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setLazyLoadingEnabled(boolean lazyLoadingEnabled) &#123;</span><br><span class="line">    this.lazyLoadingEnabled = lazyLoadingEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ProxyFactory getProxyFactory() &#123;</span><br><span class="line">    return proxyFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setProxyFactory(ProxyFactory proxyFactory) &#123;</span><br><span class="line">    if (proxyFactory == null) &#123;</span><br><span class="line">      proxyFactory = new JavassistProxyFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    this.proxyFactory = proxyFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isAggressiveLazyLoading() &#123;</span><br><span class="line">    return aggressiveLazyLoading;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setAggressiveLazyLoading(boolean aggressiveLazyLoading) &#123;</span><br><span class="line">    this.aggressiveLazyLoading = aggressiveLazyLoading;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isMultipleResultSetsEnabled() &#123;</span><br><span class="line">    return multipleResultSetsEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setMultipleResultSetsEnabled(boolean multipleResultSetsEnabled) &#123;</span><br><span class="line">    this.multipleResultSetsEnabled = multipleResultSetsEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Set&lt;String&gt; getLazyLoadTriggerMethods() &#123;</span><br><span class="line">    return lazyLoadTriggerMethods;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setLazyLoadTriggerMethods(Set&lt;String&gt; lazyLoadTriggerMethods) &#123;</span><br><span class="line">    this.lazyLoadTriggerMethods = lazyLoadTriggerMethods;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isUseGeneratedKeys() &#123;</span><br><span class="line">    return useGeneratedKeys;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setUseGeneratedKeys(boolean useGeneratedKeys) &#123;</span><br><span class="line">    this.useGeneratedKeys = useGeneratedKeys;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ExecutorType getDefaultExecutorType() &#123;</span><br><span class="line">    return defaultExecutorType;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setDefaultExecutorType(ExecutorType defaultExecutorType) &#123;</span><br><span class="line">    this.defaultExecutorType = defaultExecutorType;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isCacheEnabled() &#123;</span><br><span class="line">    return cacheEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setCacheEnabled(boolean cacheEnabled) &#123;</span><br><span class="line">    this.cacheEnabled = cacheEnabled;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Integer getDefaultStatementTimeout() &#123;</span><br><span class="line">    return defaultStatementTimeout;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setDefaultStatementTimeout(Integer defaultStatementTimeout) &#123;</span><br><span class="line">    this.defaultStatementTimeout = defaultStatementTimeout;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @since 3.3.0</span><br><span class="line">   */</span><br><span class="line">  public Integer getDefaultFetchSize() &#123;</span><br><span class="line">    return defaultFetchSize;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @since 3.3.0</span><br><span class="line">   */</span><br><span class="line">  public void setDefaultFetchSize(Integer defaultFetchSize) &#123;</span><br><span class="line">    this.defaultFetchSize = defaultFetchSize;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean isUseColumnLabel() &#123;</span><br><span class="line">    return useColumnLabel;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setUseColumnLabel(boolean useColumnLabel) &#123;</span><br><span class="line">    this.useColumnLabel = useColumnLabel;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public LocalCacheScope getLocalCacheScope() &#123;</span><br><span class="line">    return localCacheScope;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setLocalCacheScope(LocalCacheScope localCacheScope) &#123;</span><br><span class="line">    this.localCacheScope = localCacheScope;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public JdbcType getJdbcTypeForNull() &#123;</span><br><span class="line">    return jdbcTypeForNull;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setJdbcTypeForNull(JdbcType jdbcTypeForNull) &#123;</span><br><span class="line">    this.jdbcTypeForNull = jdbcTypeForNull;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Properties getVariables() &#123;</span><br><span class="line">    return variables;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setVariables(Properties variables) &#123;</span><br><span class="line">    this.variables = variables;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public TypeHandlerRegistry getTypeHandlerRegistry() &#123;</span><br><span class="line">    return typeHandlerRegistry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Set a default &#123;@link TypeHandler&#125; class for &#123;@link Enum&#125;.</span><br><span class="line">   * A default &#123;@link TypeHandler&#125; is &#123;@link org.apache.ibatis.type.EnumTypeHandler&#125;.</span><br><span class="line">   * @param typeHandler a type handler class for &#123;@link Enum&#125;</span><br><span class="line">   * @since 3.4.5</span><br><span class="line">   */</span><br><span class="line">  public void setDefaultEnumTypeHandler(Class&lt;? extends TypeHandler&gt; typeHandler) &#123;</span><br><span class="line">    if (typeHandler != null) &#123;</span><br><span class="line">      getTypeHandlerRegistry().setDefaultEnumTypeHandler(typeHandler);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public TypeAliasRegistry getTypeAliasRegistry() &#123;</span><br><span class="line">    return typeAliasRegistry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @since 3.2.2</span><br><span class="line">   */</span><br><span class="line">  public MapperRegistry getMapperRegistry() &#123;</span><br><span class="line">    return mapperRegistry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ReflectorFactory getReflectorFactory() &#123;</span><br><span class="line">	  return reflectorFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setReflectorFactory(ReflectorFactory reflectorFactory) &#123;</span><br><span class="line">	  this.reflectorFactory = reflectorFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ObjectFactory getObjectFactory() &#123;</span><br><span class="line">    return objectFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setObjectFactory(ObjectFactory objectFactory) &#123;</span><br><span class="line">    this.objectFactory = objectFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ObjectWrapperFactory getObjectWrapperFactory() &#123;</span><br><span class="line">    return objectWrapperFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setObjectWrapperFactory(ObjectWrapperFactory objectWrapperFactory) &#123;</span><br><span class="line">    this.objectWrapperFactory = objectWrapperFactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @since 3.2.2</span><br><span class="line">   */</span><br><span class="line">  public List&lt;Interceptor&gt; getInterceptors() &#123;</span><br><span class="line">    return interceptorChain.getInterceptors();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public LanguageDriverRegistry getLanguageRegistry() &#123;</span><br><span class="line">    return languageRegistry;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setDefaultScriptingLanguage(Class&lt;?&gt; driver) &#123;</span><br><span class="line">    if (driver == null) &#123;</span><br><span class="line">      driver = XMLLanguageDriver.class;</span><br><span class="line">    &#125;</span><br><span class="line">    getLanguageRegistry().setDefaultDriverClass(driver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public LanguageDriver getDefaultScriptingLanguageInstance() &#123;</span><br><span class="line">    return languageRegistry.getDefaultDriver();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /** @deprecated Use &#123;@link #getDefaultScriptingLanguageInstance()&#125; */</span><br><span class="line">  @Deprecated</span><br><span class="line">  public LanguageDriver getDefaultScriptingLanuageInstance() &#123;</span><br><span class="line">    return getDefaultScriptingLanguageInstance();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public MetaObject newMetaObject(Object object) &#123;</span><br><span class="line">    return MetaObject.forObject(object, objectFactory, objectWrapperFactory, reflectorFactory);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ParameterHandler newParameterHandler(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql) &#123;</span><br><span class="line">    ParameterHandler parameterHandler = mappedStatement.getLang().createParameterHandler(mappedStatement, parameterObject, boundSql);</span><br><span class="line">    parameterHandler = (ParameterHandler) interceptorChain.pluginAll(parameterHandler);</span><br><span class="line">    return parameterHandler;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ResultSetHandler newResultSetHandler(Executor executor, MappedStatement mappedStatement, RowBounds rowBounds, ParameterHandler parameterHandler,</span><br><span class="line">      ResultHandler resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">    ResultSetHandler resultSetHandler = new DefaultResultSetHandler(executor, mappedStatement, parameterHandler, resultHandler, boundSql, rowBounds);</span><br><span class="line">    resultSetHandler = (ResultSetHandler) interceptorChain.pluginAll(resultSetHandler);</span><br><span class="line">    return resultSetHandler;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public StatementHandler newStatementHandler(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) &#123;</span><br><span class="line">    StatementHandler statementHandler = new RoutingStatementHandler(executor, mappedStatement, parameterObject, rowBounds, resultHandler, boundSql);</span><br><span class="line">    statementHandler = (StatementHandler) interceptorChain.pluginAll(statementHandler);</span><br><span class="line">    return statementHandler;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Executor newExecutor(Transaction transaction) &#123;</span><br><span class="line">    return newExecutor(transaction, defaultExecutorType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Executor newExecutor(Transaction transaction, ExecutorType executorType) &#123;</span><br><span class="line">    executorType = executorType == null ? defaultExecutorType : executorType;</span><br><span class="line">    executorType = executorType == null ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">    Executor executor;</span><br><span class="line">    if (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">      executor = new BatchExecutor(this, transaction);</span><br><span class="line">    &#125; else if (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">      executor = new ReuseExecutor(this, transaction);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      executor = new SimpleExecutor(this, transaction);</span><br><span class="line">    &#125;</span><br><span class="line">    if (cacheEnabled) &#123;</span><br><span class="line">      executor = new CachingExecutor(executor);</span><br><span class="line">    &#125;</span><br><span class="line">    executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">    return executor;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addKeyGenerator(String id, KeyGenerator keyGenerator) &#123;</span><br><span class="line">    keyGenerators.put(id, keyGenerator);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;String&gt; getKeyGeneratorNames() &#123;</span><br><span class="line">    return keyGenerators.keySet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;KeyGenerator&gt; getKeyGenerators() &#123;</span><br><span class="line">    return keyGenerators.values();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public KeyGenerator getKeyGenerator(String id) &#123;</span><br><span class="line">    return keyGenerators.get(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean hasKeyGenerator(String id) &#123;</span><br><span class="line">    return keyGenerators.containsKey(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addCache(Cache cache) &#123;</span><br><span class="line">    caches.put(cache.getId(), cache);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;String&gt; getCacheNames() &#123;</span><br><span class="line">    return caches.keySet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;Cache&gt; getCaches() &#123;</span><br><span class="line">    return caches.values();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Cache getCache(String id) &#123;</span><br><span class="line">    return caches.get(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean hasCache(String id) &#123;</span><br><span class="line">    return caches.containsKey(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addResultMap(ResultMap rm) &#123;</span><br><span class="line">    resultMaps.put(rm.getId(), rm);</span><br><span class="line">    checkLocallyForDiscriminatedNestedResultMaps(rm);</span><br><span class="line">    checkGloballyForDiscriminatedNestedResultMaps(rm);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;String&gt; getResultMapNames() &#123;</span><br><span class="line">    return resultMaps.keySet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;ResultMap&gt; getResultMaps() &#123;</span><br><span class="line">    return resultMaps.values();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ResultMap getResultMap(String id) &#123;</span><br><span class="line">    return resultMaps.get(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean hasResultMap(String id) &#123;</span><br><span class="line">    return resultMaps.containsKey(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addParameterMap(ParameterMap pm) &#123;</span><br><span class="line">    parameterMaps.put(pm.getId(), pm);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;String&gt; getParameterMapNames() &#123;</span><br><span class="line">    return parameterMaps.keySet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;ParameterMap&gt; getParameterMaps() &#123;</span><br><span class="line">    return parameterMaps.values();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public ParameterMap getParameterMap(String id) &#123;</span><br><span class="line">    return parameterMaps.get(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean hasParameterMap(String id) &#123;</span><br><span class="line">    return parameterMaps.containsKey(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addMappedStatement(MappedStatement ms) &#123;</span><br><span class="line">    mappedStatements.put(ms.getId(), ms);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;String&gt; getMappedStatementNames() &#123;</span><br><span class="line">    buildAllStatements();</span><br><span class="line">    return mappedStatements.keySet();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;MappedStatement&gt; getMappedStatements() &#123;</span><br><span class="line">    buildAllStatements();</span><br><span class="line">    return mappedStatements.values();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;XMLStatementBuilder&gt; getIncompleteStatements() &#123;</span><br><span class="line">    return incompleteStatements;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addIncompleteStatement(XMLStatementBuilder incompleteStatement) &#123;</span><br><span class="line">    incompleteStatements.add(incompleteStatement);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;CacheRefResolver&gt; getIncompleteCacheRefs() &#123;</span><br><span class="line">    return incompleteCacheRefs;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addIncompleteCacheRef(CacheRefResolver incompleteCacheRef) &#123;</span><br><span class="line">    incompleteCacheRefs.add(incompleteCacheRef);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;ResultMapResolver&gt; getIncompleteResultMaps() &#123;</span><br><span class="line">    return incompleteResultMaps;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addIncompleteResultMap(ResultMapResolver resultMapResolver) &#123;</span><br><span class="line">    incompleteResultMaps.add(resultMapResolver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addIncompleteMethod(MethodResolver builder) &#123;</span><br><span class="line">    incompleteMethods.add(builder);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Collection&lt;MethodResolver&gt; getIncompleteMethods() &#123;</span><br><span class="line">    return incompleteMethods;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public MappedStatement getMappedStatement(String id) &#123;</span><br><span class="line">    return this.getMappedStatement(id, true);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public MappedStatement getMappedStatement(String id, boolean validateIncompleteStatements) &#123;</span><br><span class="line">    if (validateIncompleteStatements) &#123;</span><br><span class="line">      buildAllStatements();</span><br><span class="line">    &#125;</span><br><span class="line">    return mappedStatements.get(id);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public Map&lt;String, XNode&gt; getSqlFragments() &#123;</span><br><span class="line">    return sqlFragments;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addInterceptor(Interceptor interceptor) &#123;</span><br><span class="line">    interceptorChain.addInterceptor(interceptor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addMappers(String packageName, Class&lt;?&gt; superType) &#123;</span><br><span class="line">    mapperRegistry.addMappers(packageName, superType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addMappers(String packageName) &#123;</span><br><span class="line">    mapperRegistry.addMappers(packageName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public &lt;T&gt; void addMapper(Class&lt;T&gt; type) &#123;</span><br><span class="line">    mapperRegistry.addMapper(type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public &lt;T&gt; T getMapper(Class&lt;T&gt; type, SqlSession sqlSession) &#123;</span><br><span class="line">    return mapperRegistry.getMapper(type, sqlSession);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean hasMapper(Class&lt;?&gt; type) &#123;</span><br><span class="line">    return mapperRegistry.hasMapper(type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean hasStatement(String statementName) &#123;</span><br><span class="line">    return hasStatement(statementName, true);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public boolean hasStatement(String statementName, boolean validateIncompleteStatements) &#123;</span><br><span class="line">    if (validateIncompleteStatements) &#123;</span><br><span class="line">      buildAllStatements();</span><br><span class="line">    &#125;</span><br><span class="line">    return mappedStatements.containsKey(statementName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void addCacheRef(String namespace, String referencedNamespace) &#123;</span><br><span class="line">    cacheRefMap.put(namespace, referencedNamespace);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /*</span><br><span class="line">   * Parses all the unprocessed statement nodes in the cache. It is recommended</span><br><span class="line">   * to call this method once all the mappers are added as it provides fail-fast</span><br><span class="line">   * statement validation.</span><br><span class="line">   */</span><br><span class="line">  protected void buildAllStatements() &#123;</span><br><span class="line">    if (!incompleteResultMaps.isEmpty()) &#123;</span><br><span class="line">      synchronized (incompleteResultMaps) &#123;</span><br><span class="line">        // This always throws a BuilderException.</span><br><span class="line">        incompleteResultMaps.iterator().next().resolve();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!incompleteCacheRefs.isEmpty()) &#123;</span><br><span class="line">      synchronized (incompleteCacheRefs) &#123;</span><br><span class="line">        // This always throws a BuilderException.</span><br><span class="line">        incompleteCacheRefs.iterator().next().resolveCacheRef();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!incompleteStatements.isEmpty()) &#123;</span><br><span class="line">      synchronized (incompleteStatements) &#123;</span><br><span class="line">        // This always throws a BuilderException.</span><br><span class="line">        incompleteStatements.iterator().next().parseStatementNode();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!incompleteMethods.isEmpty()) &#123;</span><br><span class="line">      synchronized (incompleteMethods) &#123;</span><br><span class="line">        // This always throws a BuilderException.</span><br><span class="line">        incompleteMethods.iterator().next().resolve();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /*</span><br><span class="line">   * Extracts namespace from fully qualified statement id.</span><br><span class="line">   *</span><br><span class="line">   * @param statementId</span><br><span class="line">   * @return namespace or null when id does not contain period.</span><br><span class="line">   */</span><br><span class="line">  protected String extractNamespace(String statementId) &#123;</span><br><span class="line">    int lastPeriod = statementId.lastIndexOf(&apos;.&apos;);</span><br><span class="line">    return lastPeriod &gt; 0 ? statementId.substring(0, lastPeriod) : null;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Slow but a one time cost. A better solution is welcome.</span><br><span class="line">  protected void checkGloballyForDiscriminatedNestedResultMaps(ResultMap rm) &#123;</span><br><span class="line">    if (rm.hasNestedResultMaps()) &#123;</span><br><span class="line">      for (Map.Entry&lt;String, ResultMap&gt; entry : resultMaps.entrySet()) &#123;</span><br><span class="line">        Object value = entry.getValue();</span><br><span class="line">        if (value instanceof ResultMap) &#123;</span><br><span class="line">          ResultMap entryResultMap = (ResultMap) value;</span><br><span class="line">          if (!entryResultMap.hasNestedResultMaps() &amp;&amp; entryResultMap.getDiscriminator() != null) &#123;</span><br><span class="line">            Collection&lt;String&gt; discriminatedResultMapNames = entryResultMap.getDiscriminator().getDiscriminatorMap().values();</span><br><span class="line">            if (discriminatedResultMapNames.contains(rm.getId())) &#123;</span><br><span class="line">              entryResultMap.forceNestedResultMaps();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Slow but a one time cost. A better solution is welcome.</span><br><span class="line">  protected void checkLocallyForDiscriminatedNestedResultMaps(ResultMap rm) &#123;</span><br><span class="line">    if (!rm.hasNestedResultMaps() &amp;&amp; rm.getDiscriminator() != null) &#123;</span><br><span class="line">      for (Map.Entry&lt;String, String&gt; entry : rm.getDiscriminator().getDiscriminatorMap().entrySet()) &#123;</span><br><span class="line">        String discriminatedResultMapName = entry.getValue();</span><br><span class="line">        if (hasResultMap(discriminatedResultMapName)) &#123;</span><br><span class="line">          ResultMap discriminatedResultMap = resultMaps.get(discriminatedResultMapName);</span><br><span class="line">          if (discriminatedResultMap.hasNestedResultMaps()) &#123;</span><br><span class="line">            rm.forceNestedResultMaps();</span><br><span class="line">            break;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  protected static class StrictMap&lt;V&gt; extends HashMap&lt;String, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = -4950446264854982944L;</span><br><span class="line">    private final String name;</span><br><span class="line"></span><br><span class="line">    public StrictMap(String name, int initialCapacity, float loadFactor) &#123;</span><br><span class="line">      super(initialCapacity, loadFactor);</span><br><span class="line">      this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public StrictMap(String name, int initialCapacity) &#123;</span><br><span class="line">      super(initialCapacity);</span><br><span class="line">      this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public StrictMap(String name) &#123;</span><br><span class="line">      super();</span><br><span class="line">      this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public StrictMap(String name, Map&lt;String, ? extends V&gt; m) &#123;</span><br><span class="line">      super(m);</span><br><span class="line">      this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public V put(String key, V value) &#123;</span><br><span class="line">      if (containsKey(key)) &#123;</span><br><span class="line">        throw new IllegalArgumentException(name + &quot; already contains value for &quot; + key);</span><br><span class="line">      &#125;</span><br><span class="line">      if (key.contains(&quot;.&quot;)) &#123;</span><br><span class="line">        final String shortKey = getShortName(key);</span><br><span class="line">        if (super.get(shortKey) == null) &#123;</span><br><span class="line">          super.put(shortKey, value);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          super.put(shortKey, (V) new Ambiguity(shortKey));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return super.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public V get(Object key) &#123;</span><br><span class="line">      V value = super.get(key);</span><br><span class="line">      if (value == null) &#123;</span><br><span class="line">        throw new IllegalArgumentException(name + &quot; does not contain value for &quot; + key);</span><br><span class="line">      &#125;</span><br><span class="line">      if (value instanceof Ambiguity) &#123;</span><br><span class="line">        throw new IllegalArgumentException(((Ambiguity) value).getSubject() + &quot; is ambiguous in &quot; + name</span><br><span class="line">            + &quot; (try using the full name including the namespace, or rename one of the entries)&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      return value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String getShortName(String key) &#123;</span><br><span class="line">      final String[] keyParts = key.split(&quot;\\.&quot;);</span><br><span class="line">      return keyParts[keyParts.length - 1];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected static class Ambiguity &#123;</span><br><span class="line">      final private String subject;</span><br><span class="line"></span><br><span class="line">      public Ambiguity(String subject) &#123;</span><br><span class="line">        this.subject = subject;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      public String getSubject() &#123;</span><br><span class="line">        return subject;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>然后代码跳到这里</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">public class SqlSessionFactoryBean implements FactoryBean&lt;SqlSessionFactory&gt;, InitializingBean, ApplicationListener&lt;ApplicationEvent&gt; &#123;</span><br><span class="line">...</span><br><span class="line">//这里是创建唯一的sqlsessionFactory注意这个注解ConditionalOnMissingBean</span><br><span class="line">  @Bean</span><br><span class="line">  @ConditionalOnMissingBean</span><br><span class="line">  public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception &#123;</span><br><span class="line">    SqlSessionFactoryBean factory = new SqlSessionFactoryBean();</span><br><span class="line">    factory.setDataSource(dataSource);</span><br><span class="line">    factory.setVfs(SpringBootVFS.class);</span><br><span class="line">    if (StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">      factory.setConfigLocation(this.resourceLoader.getResource(this.properties.getConfigLocation()));</span><br><span class="line">    &#125;</span><br><span class="line">    Configuration configuration = this.properties.getConfiguration();</span><br><span class="line">    if (configuration == null &amp;&amp; !StringUtils.hasText(this.properties.getConfigLocation())) &#123;</span><br><span class="line">      configuration = new Configuration();</span><br><span class="line">    &#125;</span><br><span class="line">    if (configuration != null &amp;&amp; !CollectionUtils.isEmpty(this.configurationCustomizers)) &#123;</span><br><span class="line">      for (ConfigurationCustomizer customizer : this.configurationCustomizers) &#123;</span><br><span class="line">        customizer.customize(configuration);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    factory.setConfiguration(configuration);</span><br><span class="line">    if (this.properties.getConfigurationProperties() != null) &#123;</span><br><span class="line">      factory.setConfigurationProperties(this.properties.getConfigurationProperties());</span><br><span class="line">    &#125;</span><br><span class="line">    if (!ObjectUtils.isEmpty(this.interceptors)) &#123;</span><br><span class="line">      factory.setPlugins(this.interceptors);</span><br><span class="line">    &#125;</span><br><span class="line">    if (this.databaseIdProvider != null) &#123;</span><br><span class="line">      factory.setDatabaseIdProvider(this.databaseIdProvider);</span><br><span class="line">    &#125;</span><br><span class="line">    if (StringUtils.hasLength(this.properties.getTypeAliasesPackage())) &#123;</span><br><span class="line">      factory.setTypeAliasesPackage(this.properties.getTypeAliasesPackage());</span><br><span class="line">    &#125;</span><br><span class="line">    if (StringUtils.hasLength(this.properties.getTypeHandlersPackage())) &#123;</span><br><span class="line">      factory.setTypeHandlersPackage(this.properties.getTypeHandlersPackage());</span><br><span class="line">    &#125;</span><br><span class="line">    if (!ObjectUtils.isEmpty(this.properties.resolveMapperLocations())) &#123;</span><br><span class="line">      factory.setMapperLocations(this.properties.resolveMapperLocations());</span><br><span class="line">    &#125;</span><br><span class="line">	//创建工厂</span><br><span class="line">    return factory.getObject();</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">  /**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">   //先走这个方法</span><br><span class="line">  @Override</span><br><span class="line">  public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">    notNull(dataSource, &quot;Property &apos;dataSource&apos; is required&quot;);</span><br><span class="line">    notNull(sqlSessionFactoryBuilder, &quot;Property &apos;sqlSessionFactoryBuilder&apos; is required&quot;);</span><br><span class="line">    state((configuration == null &amp;&amp; configLocation == null) || !(configuration != null &amp;&amp; configLocation != null),</span><br><span class="line">              &quot;Property &apos;configuration&apos; and &apos;configLocation&apos; can not specified with together&quot;);</span><br><span class="line">	//走这里进行build工厂类</span><br><span class="line">    this.sqlSessionFactory = buildSqlSessionFactory();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  //注意了具体的配置过程在这里</span><br><span class="line">    protected SqlSessionFactory buildSqlSessionFactory() throws IOException &#123;</span><br><span class="line"></span><br><span class="line">    Configuration configuration;</span><br><span class="line"></span><br><span class="line">    XMLConfigBuilder xmlConfigBuilder = null;</span><br><span class="line">    if (this.configuration != null) &#123;</span><br><span class="line">      configuration = this.configuration;</span><br><span class="line">      if (configuration.getVariables() == null) &#123;</span><br><span class="line">        configuration.setVariables(this.configurationProperties);</span><br><span class="line">      &#125; else if (this.configurationProperties != null) &#123;</span><br><span class="line">        configuration.getVariables().putAll(this.configurationProperties);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (this.configLocation != null) &#123;</span><br><span class="line">      xmlConfigBuilder = new XMLConfigBuilder(this.configLocation.getInputStream(), null, this.configurationProperties);</span><br><span class="line">      configuration = xmlConfigBuilder.getConfiguration();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">        LOGGER.debug(&quot;Property &apos;configuration&apos; or &apos;configLocation&apos; not specified, using default MyBatis Configuration&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      configuration = new Configuration();</span><br><span class="line">      if (this.configurationProperties != null) &#123;</span><br><span class="line">        configuration.setVariables(this.configurationProperties);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.objectFactory != null) &#123;</span><br><span class="line">      configuration.setObjectFactory(this.objectFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.objectWrapperFactory != null) &#123;</span><br><span class="line">      configuration.setObjectWrapperFactory(this.objectWrapperFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.vfs != null) &#123;</span><br><span class="line">      configuration.setVfsImpl(this.vfs);</span><br><span class="line">    &#125;</span><br><span class="line">	//this.typeAliasesPackage=application.properties中的mybatis.type-aliases-package</span><br><span class="line">    if (hasLength(this.typeAliasesPackage)) &#123;</span><br><span class="line">      String[] typeAliasPackageArray = tokenizeToStringArray(this.typeAliasesPackage,</span><br><span class="line">          ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line">      for (String packageToScan : typeAliasPackageArray) &#123;</span><br><span class="line">        configuration.getTypeAliasRegistry().registerAliases(packageToScan,</span><br><span class="line">                typeAliasesSuperType == null ? Object.class : typeAliasesSuperType);</span><br><span class="line">        if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">          LOGGER.debug(&quot;Scanned package: &apos;&quot; + packageToScan + &quot;&apos; for aliases&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	//注册别名类到configuration</span><br><span class="line">    if (!isEmpty(this.typeAliases)) &#123;</span><br><span class="line">      for (Class&lt;?&gt; typeAlias : this.typeAliases) &#123;</span><br><span class="line">        configuration.getTypeAliasRegistry().registerAlias(typeAlias);</span><br><span class="line">        if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">          LOGGER.debug(&quot;Registered type alias: &apos;&quot; + typeAlias + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	//看看有没有配置插件有的话加入到拦截器组</span><br><span class="line">    if (!isEmpty(this.plugins)) &#123;</span><br><span class="line">      for (Interceptor plugin : this.plugins) &#123;</span><br><span class="line">        configuration.addInterceptor(plugin);</span><br><span class="line">        if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">          LOGGER.debug(&quot;Registered plugin: &apos;&quot; + plugin + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	//看看有没有typeHandlersPackage，有的话注册到cfg类中</span><br><span class="line">    if (hasLength(this.typeHandlersPackage)) &#123;</span><br><span class="line">      String[] typeHandlersPackageArray = tokenizeToStringArray(this.typeHandlersPackage,</span><br><span class="line">          ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);</span><br><span class="line">      for (String packageToScan : typeHandlersPackageArray) &#123;</span><br><span class="line">        configuration.getTypeHandlerRegistry().register(packageToScan);</span><br><span class="line">        if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">          LOGGER.debug(&quot;Scanned package: &apos;&quot; + packageToScan + &quot;&apos; for type handlers&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	//看看有没有typeHandlers，有的话注册到cfg类中</span><br><span class="line">    if (!isEmpty(this.typeHandlers)) &#123;</span><br><span class="line">      for (TypeHandler&lt;?&gt; typeHandler : this.typeHandlers) &#123;</span><br><span class="line">        configuration.getTypeHandlerRegistry().register(typeHandler);</span><br><span class="line">        if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">          LOGGER.debug(&quot;Registered type handler: &apos;&quot; + typeHandler + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	//看看有没有设置databaseid 有的话配置到cfg类中</span><br><span class="line">    if (this.databaseIdProvider != null) &#123;//fix #64 set databaseId before parse mapper xmls</span><br><span class="line">      try &#123;</span><br><span class="line">        configuration.setDatabaseId(this.databaseIdProvider.getDatabaseId(this.dataSource));</span><br><span class="line">      &#125; catch (SQLException e) &#123;</span><br><span class="line">        throw new NestedIOException(&quot;Failed getting a databaseId&quot;, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (this.cache != null) &#123;</span><br><span class="line">      configuration.addCache(this.cache);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (xmlConfigBuilder != null) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        xmlConfigBuilder.parse();</span><br><span class="line"></span><br><span class="line">        if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">          LOGGER.debug(&quot;Parsed configuration file: &apos;&quot; + this.configLocation + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (Exception ex) &#123;</span><br><span class="line">        throw new NestedIOException(&quot;Failed to parse config resource: &quot; + this.configLocation, ex);</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">//如果transactionFactory是空的话 new一个 Spring的事务工厂</span><br><span class="line">    if (this.transactionFactory == null) &#123;</span><br><span class="line">      this.transactionFactory = new SpringManagedTransactionFactory();</span><br><span class="line">    &#125;</span><br><span class="line">	//这里很重要 将spring的环境对象 和事务工厂还有数据源对象注册到cfg类中</span><br><span class="line">    configuration.setEnvironment(new Environment(this.environment, this.transactionFactory, this.dataSource));</span><br><span class="line">	//this.mapperLocation=application.properties中配置的mybatis.mapper-locations</span><br><span class="line">	//拿到mapper文件的配置类</span><br><span class="line">    if (!isEmpty(this.mapperLocations)) &#123;</span><br><span class="line">      for (Resource mapperLocation : this.mapperLocations) &#123;</span><br><span class="line">        if (mapperLocation == null) &#123;</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">        //构建xmlMapperBuilder</span><br><span class="line">          XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(mapperLocation.getInputStream(),</span><br><span class="line">              configuration, mapperLocation.toString(), configuration.getSqlFragments());</span><br><span class="line">              //</span><br><span class="line">          xmlMapperBuilder.parse();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">          throw new NestedIOException(&quot;Failed to parse mapping resource: &apos;&quot; + mapperLocation + &quot;&apos;&quot;, e);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">          ErrorContext.instance().reset();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">          LOGGER.debug(&quot;Parsed mapper file: &apos;&quot; + mapperLocation + &quot;&apos;&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">        LOGGER.debug(&quot;Property &apos;mapperLocations&apos; was not specified or no matching resources found&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	//最后创建sqlsessionFactory</span><br><span class="line">    return this.sqlSessionFactoryBuilder.build(configuration);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>configuration.getTypeAliasRegistry().registerAliases的操作</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public void registerAliases(String packageName, Class&lt;?&gt; superType)&#123;</span><br><span class="line">   ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = new ResolverUtil&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">   resolverUtil.find(new ResolverUtil.IsA(superType), packageName);</span><br><span class="line">   Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; typeSet = resolverUtil.getClasses();</span><br><span class="line">   for(Class&lt;?&gt; type : typeSet)&#123;</span><br><span class="line">     // Ignore inner classes and interfaces (including package-info.java)</span><br><span class="line">     // Skip also inner classes. See issue #6</span><br><span class="line">     if (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) &#123;</span><br><span class="line">       //注册别名</span><br><span class="line">       registerAlias(type);</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> //上面代码调到这里</span><br><span class="line"> public void registerAlias(Class&lt;?&gt; type) &#123;</span><br><span class="line">   String alias = type.getSimpleName();</span><br><span class="line">   //先获得class上的注解 </span><br><span class="line">   Alias aliasAnnotation = type.getAnnotation(Alias.class);</span><br><span class="line">   if (aliasAnnotation != null) &#123;</span><br><span class="line">     //如果有的话拿到注解的值</span><br><span class="line">     alias = aliasAnnotation.value();</span><br><span class="line">   &#125; </span><br><span class="line">   //</span><br><span class="line">   registerAlias(alias, type);</span><br><span class="line"> &#125;</span><br><span class="line"> //再跳到这里</span><br><span class="line"> public void registerAlias(String alias, Class&lt;?&gt; value) &#123;</span><br><span class="line">   if (alias == null) &#123;</span><br><span class="line">     throw new TypeException(&quot;The parameter alias cannot be null&quot;);</span><br><span class="line">   &#125;</span><br><span class="line">   // issue #748</span><br><span class="line">   String key = alias.toLowerCase(Locale.ENGLISH);</span><br><span class="line">   if (TYPE_ALIASES.containsKey(key) &amp;&amp; TYPE_ALIASES.get(key) != null &amp;&amp; !TYPE_ALIASES.get(key).equals(value)) &#123;</span><br><span class="line">     throw new TypeException(&quot;The alias &apos;&quot; + alias + &quot;&apos; is already mapped to the value &apos;&quot; + TYPE_ALIASES.get(key).getName() + &quot;&apos;.&quot;);</span><br><span class="line">   &#125;</span><br><span class="line">   //这里key=userroledto value=class com.convergence.domain.UserRoleDTO</span><br><span class="line">   TYPE_ALIASES.put(key, value);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>进行解析</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">public void parse() &#123;</span><br><span class="line">    if (!configuration.isResourceLoaded(resource)) &#123;</span><br><span class="line">      configurationElement(parser.evalNode(&quot;/mapper&quot;));</span><br><span class="line">      configuration.addLoadedResource(resource);</span><br><span class="line">      //绑定namespace</span><br><span class="line">      bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line">	//解析resultMaps</span><br><span class="line">    parsePendingResultMaps();</span><br><span class="line">    parsePendingCacheRefs();</span><br><span class="line">    parsePendingStatements();</span><br><span class="line">  &#125;</span><br><span class="line">  //解析xml文件</span><br><span class="line">  private void configurationElement(XNode context) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      String namespace = context.getStringAttribute(&quot;namespace&quot;);</span><br><span class="line">      if (namespace == null || namespace.equals(&quot;&quot;)) &#123;</span><br><span class="line">        throw new BuilderException(&quot;Mapper&apos;s namespace cannot be empty&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">      builderAssistant.setCurrentNamespace(namespace);</span><br><span class="line">      //这里的context就是xml文件内容了</span><br><span class="line">      cacheRefElement(context.evalNode(&quot;cache-ref&quot;));</span><br><span class="line">      cacheElement(context.evalNode(&quot;cache&quot;));</span><br><span class="line">      parameterMapElement(context.evalNodes(&quot;/mapper/parameterMap&quot;));</span><br><span class="line">      resultMapElements(context.evalNodes(&quot;/mapper/resultMap&quot;));</span><br><span class="line">      sqlElement(context.evalNodes(&quot;/mapper/sql&quot;));</span><br><span class="line">      buildStatementFromContext(context.evalNodes(&quot;select|insert|update|delete&quot;));</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw new BuilderException(&quot;Error parsing Mapper XML. Cause: &quot; + e, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  //将mapper.java和xml进行绑定</span><br><span class="line">  private void bindMapperForNamespace() &#123;</span><br><span class="line">    String namespace = builderAssistant.getCurrentNamespace();</span><br><span class="line">    if (namespace != null) &#123;</span><br><span class="line">      Class&lt;?&gt; boundType = null;</span><br><span class="line">      try &#123;</span><br><span class="line">        boundType = Resources.classForName(namespace);</span><br><span class="line">      &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">        //ignore, bound type is not required</span><br><span class="line">      &#125;</span><br><span class="line">      if (boundType != null) &#123;</span><br><span class="line">        if (!configuration.hasMapper(boundType)) &#123;</span><br><span class="line">          // Spring may not know the real resource name so we set a flag</span><br><span class="line">          // to prevent loading again this resource from the mapper interface</span><br><span class="line">          // look at MapperAnnotationBuilder#loadXmlResource</span><br><span class="line">          configuration.addLoadedResource(&quot;namespace:&quot; + namespace);</span><br><span class="line">          configuration.addMapper(boundType);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  //解析resultmap</span><br><span class="line"> private void parsePendingResultMaps() &#123;</span><br><span class="line">    Collection&lt;ResultMapResolver&gt; incompleteResultMaps = configuration.getIncompleteResultMaps();</span><br><span class="line">    synchronized (incompleteResultMaps) &#123;</span><br><span class="line">      Iterator&lt;ResultMapResolver&gt; iter = incompleteResultMaps.iterator();</span><br><span class="line">      while (iter.hasNext()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          iter.next().resolve();</span><br><span class="line">          iter.remove();</span><br><span class="line">        &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">          // ResultMap is still missing a resource...</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  //缓存解析</span><br><span class="line">  private void parsePendingCacheRefs() &#123;</span><br><span class="line">    Collection&lt;CacheRefResolver&gt; incompleteCacheRefs = configuration.getIncompleteCacheRefs();</span><br><span class="line">    synchronized (incompleteCacheRefs) &#123;</span><br><span class="line">      Iterator&lt;CacheRefResolver&gt; iter = incompleteCacheRefs.iterator();</span><br><span class="line">      while (iter.hasNext()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          iter.next().resolveCacheRef();</span><br><span class="line">          iter.remove();</span><br><span class="line">        &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">          // Cache ref is still missing a resource...</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  //statment解析</span><br><span class="line">    private void parsePendingStatements() &#123;</span><br><span class="line">    Collection&lt;XMLStatementBuilder&gt; incompleteStatements = configuration.getIncompleteStatements();</span><br><span class="line">    synchronized (incompleteStatements) &#123;</span><br><span class="line">      Iterator&lt;XMLStatementBuilder&gt; iter = incompleteStatements.iterator();</span><br><span class="line">      while (iter.hasNext()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          iter.next().parseStatementNode();</span><br><span class="line">          iter.remove();</span><br><span class="line">        &#125; catch (IncompleteElementException e) &#123;</span><br><span class="line">          // Statement is still missing a resource...</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>上面的工厂实例完了 进入sqlsessiontemplate实例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//这里需要上面构建的sqlSessionFactory</span><br><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">  ExecutorType executorType = this.properties.getExecutorType();</span><br><span class="line">  if (executorType != null) &#123;</span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory, executorType);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>构建SqlSessionTemplate</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class SqlSessionTemplate implements SqlSession, DisposableBean &#123;</span><br><span class="line">...</span><br><span class="line">/**</span><br><span class="line">  * Constructs a Spring managed &#123;@code SqlSession&#125; with the given</span><br><span class="line">  * &#123;@code SqlSessionFactory&#125; and &#123;@code ExecutorType&#125;.</span><br><span class="line">  * A custom &#123;@code SQLExceptionTranslator&#125; can be provided as an</span><br><span class="line">  * argument so any &#123;@code PersistenceException&#125; thrown by MyBatis</span><br><span class="line">  * can be custom translated to a &#123;@code RuntimeException&#125;</span><br><span class="line">  * The &#123;@code SQLExceptionTranslator&#125; can also be null and thus no</span><br><span class="line">  * exception translation will be done and MyBatis exceptions will be</span><br><span class="line">  * thrown</span><br><span class="line">  *</span><br><span class="line">  * @param sqlSessionFactory</span><br><span class="line">  * @param executorType</span><br><span class="line">  * @param exceptionTranslator</span><br><span class="line">  */</span><br><span class="line"> public SqlSessionTemplate(SqlSessionFactory sqlSessionFactory, ExecutorType executorType,</span><br><span class="line">     PersistenceExceptionTranslator exceptionTranslator) &#123;</span><br><span class="line">  </span><br><span class="line">   notNull(sqlSessionFactory, &quot;Property &apos;sqlSessionFactory&apos; is required&quot;);</span><br><span class="line">   notNull(executorType, &quot;Property &apos;executorType&apos; is required&quot;);</span><br><span class="line">  </span><br><span class="line">   this.sqlSessionFactory = sqlSessionFactory;</span><br><span class="line">   this.executorType = executorType;</span><br><span class="line">   this.exceptionTranslator = exceptionTranslator;</span><br><span class="line">   //获得一个sqlsession代理类 里面填充了sqlSessionInterceptor</span><br><span class="line">   this.sqlSessionProxy = (SqlSession) newProxyInstance(</span><br><span class="line">       SqlSessionFactory.class.getClassLoader(),</span><br><span class="line">       new Class[] &#123; SqlSession.class &#125;,</span><br><span class="line">       new SqlSessionInterceptor());</span><br><span class="line"> &#125;</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>*<em>这里说下ExecutorType *</em></p>
<ul>
<li>*<em>simple 默认的 *</em></li>
<li><strong>reuse 这个类型不做特殊的事情，它只为每个语句创建一个 PreparedStatement。</strong></li>
<li>*<em>batch 批处理语句使用 需要关闭autocommit      *</em></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public enum ExecutorType &#123;</span><br><span class="line">  SIMPLE, REUSE, BATCH</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>在创建sqlSessionTemplate的时候会创建一个SqlSessionInterceptor</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">  private class SqlSessionInterceptor implements InvocationHandler &#123;</span><br><span class="line">...</span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">    //首先获取到sqlsession</span><br><span class="line">      SqlSession sqlSession = getSqlSession(</span><br><span class="line">          SqlSessionTemplate.this.sqlSessionFactory,</span><br><span class="line">          SqlSessionTemplate.this.executorType,</span><br><span class="line">          SqlSessionTemplate.this.exceptionTranslator);</span><br><span class="line">      try &#123;</span><br><span class="line">      //进行involke 拿到具体的结果集</span><br><span class="line">        Object result = method.invoke(sqlSession, args);</span><br><span class="line">        //这个if判断：    return (holder != null) &amp;&amp; (holder.getSqlSession() == session);</span><br><span class="line">        if (!isSqlSessionTransactional(sqlSession, SqlSessionTemplate.this.sqlSessionFactory)) &#123;</span><br><span class="line">          // force commit even on non-dirty sessions because some databases require</span><br><span class="line">          // a commit/rollback before calling close()</span><br><span class="line">          //然后commit</span><br><span class="line">          sqlSession.commit(true);</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">      &#125; catch (Throwable t) &#123;</span><br><span class="line">        Throwable unwrapped = unwrapThrowable(t);</span><br><span class="line">        if (SqlSessionTemplate.this.exceptionTranslator != null &amp;&amp; unwrapped instanceof PersistenceException) &#123;</span><br><span class="line">          // release the connection to avoid a deadlock if the translator is no loaded. See issue #22</span><br><span class="line">          closeSqlSession(sqlSession, SqlSessionTemplate.this.sqlSessionFactory);</span><br><span class="line">          sqlSession = null;</span><br><span class="line">          Throwable translated = SqlSessionTemplate.this.exceptionTranslator.translateExceptionIfPossible((PersistenceException) unwrapped);</span><br><span class="line">          if (translated != null) &#123;</span><br><span class="line">            unwrapped = translated;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        throw unwrapped;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        if (sqlSession != null) &#123;</span><br><span class="line">        //关闭会话</span><br><span class="line">          closeSqlSession(sqlSession, SqlSessionTemplate.this.sqlSessionFactory);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>getSqlSession:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> public static SqlSession getSqlSession(SqlSessionFactory sessionFactory, ExecutorType executorType, PersistenceExceptionTranslator exceptionTranslator) &#123;</span><br><span class="line">  </span><br><span class="line">   notNull(sessionFactory, NO_SQL_SESSION_FACTORY_SPECIFIED);</span><br><span class="line">   notNull(executorType, NO_EXECUTOR_TYPE_SPECIFIED);</span><br><span class="line">//holder</span><br><span class="line">   SqlSessionHolder holder = (SqlSessionHolder) </span><br><span class="line">   //事务管理器拿到holder</span><br><span class="line">   TransactionSynchronizationManager.getResource(sessionFactory);</span><br><span class="line">//获得session</span><br><span class="line">   SqlSession session = sessionHolder(executorType, holder);</span><br><span class="line">   if (session != null) &#123;</span><br><span class="line">     return session;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">     LOGGER.debug(&quot;Creating a new SqlSession&quot;);</span><br><span class="line">   &#125;</span><br><span class="line">//工厂打开session</span><br><span class="line">   session = sessionFactory.openSession(executorType);</span><br><span class="line">//注册session,工厂到holder</span><br><span class="line">   registerSessionHolder(sessionFactory, executorType, exceptionTranslator, session);</span><br><span class="line">  </span><br><span class="line">   return session;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>registerSessionHolder:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  private static void registerSessionHolder(SqlSessionFactory sessionFactory, ExecutorType executorType,</span><br><span class="line">      PersistenceExceptionTranslator exceptionTranslator, SqlSession session) &#123;</span><br><span class="line">    SqlSessionHolder holder;</span><br><span class="line">    if (TransactionSynchronizationManager.isSynchronizationActive()) &#123;</span><br><span class="line">      Environment environment = sessionFactory.getConfiguration().getEnvironment();</span><br><span class="line">	  //如果当前的事务工厂是spring的事务管理工厂的实例的话</span><br><span class="line">      if (environment.getTransactionFactory() instanceof SpringManagedTransactionFactory) &#123;</span><br><span class="line">        if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">          LOGGER.debug(&quot;Registering transaction synchronization for SqlSession [&quot; + session + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">	   //创建holder</span><br><span class="line">        holder = new SqlSessionHolder(session, executorType, exceptionTranslator);</span><br><span class="line">        //底下是事务的一系列管理操作</span><br><span class="line">        TransactionSynchronizationManager.bindResource(sessionFactory, holder);</span><br><span class="line">        TransactionSynchronizationManager.registerSynchronization(new SqlSessionSynchronization(holder, sessionFactory));</span><br><span class="line">        holder.setSynchronizedWithTransaction(true);</span><br><span class="line">        holder.requested();</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        if (TransactionSynchronizationManager.getResource(environment.getDataSource()) == null) &#123;</span><br><span class="line">          if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">            LOGGER.debug(&quot;SqlSession [&quot; + session + &quot;] was not registered for synchronization because DataSource is not transactional&quot;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          throw new TransientDataAccessResourceException(</span><br><span class="line">              &quot;SqlSessionFactory must be using a SpringManagedTransactionFactory in order to use Spring transaction synchronization&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (LOGGER.isDebugEnabled()) &#123;</span><br><span class="line">        LOGGER.debug(&quot;SqlSession [&quot; + session + &quot;] was not registered for synchronization because synchronization is not active&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体的sql执行过程</strong></p>
</li>
</ul>
<p>  <strong>mybatis中的每个dao都会继承SqlSessionDaoSupport，在于spring集成的时候，需要依赖spring-mybatis这个jar，而这个SqlSessionDaoSupport类就在这个jar中</strong></p>
<p>  <strong>这是个抽象类。</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">package org.mybatis.spring.support;</span><br><span class="line"></span><br><span class="line">import static org.springframework.util.Assert.notNull;</span><br><span class="line"></span><br><span class="line">import org.apache.ibatis.session.SqlSession;</span><br><span class="line">import org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line">import org.mybatis.spring.SqlSessionTemplate;</span><br><span class="line">import org.springframework.dao.support.DaoSupport;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Convenient super class for MyBatis SqlSession data access objects.</span><br><span class="line"> * It gives you access to the template which can then be used to execute SQL methods.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * This class needs a SqlSessionTemplate or a SqlSessionFactory.</span><br><span class="line"> * If both are set the SqlSessionFactory will be ignored.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * &#123;code Autowired&#125; was removed from setSqlSessionTemplate and setSqlSessionFactory</span><br><span class="line"> * in version 1.2.0.</span><br><span class="line"> * </span><br><span class="line"> * @author Putthibong Boonbong</span><br><span class="line"> *</span><br><span class="line"> * @see #setSqlSessionFactory</span><br><span class="line"> * @see #setSqlSessionTemplate</span><br><span class="line"> * @see SqlSessionTemplate</span><br><span class="line"> */</span><br><span class="line">public abstract class SqlSessionDaoSupport extends DaoSupport &#123;</span><br><span class="line"></span><br><span class="line">  private SqlSession sqlSession;</span><br><span class="line"></span><br><span class="line">  private boolean externalSqlSession;</span><br><span class="line"></span><br><span class="line">  public void setSqlSessionFactory(SqlSessionFactory sqlSessionFactory) &#123;</span><br><span class="line">    if (!this.externalSqlSession) &#123;</span><br><span class="line">      this.sqlSession = new SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void setSqlSessionTemplate(SqlSessionTemplate sqlSessionTemplate) &#123;</span><br><span class="line">    this.sqlSession = sqlSessionTemplate;</span><br><span class="line">    this.externalSqlSession = true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Users should use this method to get a SqlSession to call its statement methods</span><br><span class="line">   * This is SqlSession is managed by spring. Users should not commit/rollback/close it</span><br><span class="line">   * because it will be automatically done.</span><br><span class="line">   *</span><br><span class="line">   * @return Spring managed thread safe SqlSession</span><br><span class="line">   */</span><br><span class="line">  public SqlSession getSqlSession() &#123;</span><br><span class="line">    return this.sqlSession;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  protected void checkDaoConfig() &#123;</span><br><span class="line">    notNull(this.sqlSession, &quot;Property &apos;sqlSessionFactory&apos; or &apos;sqlSessionTemplate&apos; are required&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>那么它的父类DaoSupport什么时候</strong></p>
<p>  <strong>注意实现了InitializingBean这个是由spring管理的</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory</span><br><span class="line">		implements AutowireCapableBeanFactory &#123;</span><br><span class="line">		//</span><br><span class="line">	/**</span><br><span class="line">	 * Give a bean a chance to react now all its properties are set,</span><br><span class="line">	 * and a chance to know about its owning bean factory (this object).</span><br><span class="line">	 * This means checking whether the bean implements InitializingBean or defines</span><br><span class="line">	 * a custom init method, and invoking the necessary callback(s) if it does.</span><br><span class="line">	 * @param beanName the bean name in the factory (for debugging purposes)</span><br><span class="line">	 * @param bean the new bean instance we may need to initialize</span><br><span class="line">	 * @param mbd the merged bean definition that the bean was created with</span><br><span class="line">	 * (can also be &#123;@code null&#125;, if given an existing bean instance)</span><br><span class="line">	 * @throws Throwable if thrown by init methods or by the invocation process</span><br><span class="line">	 * @see #invokeCustomInitMethod</span><br><span class="line">	 */</span><br><span class="line">	 //根据bean的name来反射加载初始方法 当bean DataSourceInitializerInvoker被加载时候会触发事件驱动 去构建sqlsessionFactory</span><br><span class="line">	 //当bean=MapperFactoryBean的时候 先走父类DaoSupport的afterPropertiesSet</span><br><span class="line">	protected void invokeInitMethods(String beanName, final Object bean, @Nullable RootBeanDefinition mbd)</span><br><span class="line">			throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">		boolean isInitializingBean = (bean instanceof InitializingBean);</span><br><span class="line">		if (isInitializingBean &amp;&amp; (mbd == null || !mbd.isExternallyManagedInitMethod(&quot;afterPropertiesSet&quot;))) &#123;</span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Invoking afterPropertiesSet() on bean with name &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			if (System.getSecurityManager() != null) &#123;</span><br><span class="line">				try &#123;</span><br><span class="line">					AccessController.doPrivileged((PrivilegedExceptionAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">						((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">						return null;</span><br><span class="line">					&#125;, getAccessControlContext());</span><br><span class="line">				&#125;</span><br><span class="line">				catch (PrivilegedActionException pae) &#123;</span><br><span class="line">					throw pae.getException();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">			//在这里会初始化dao</span><br><span class="line">				((InitializingBean) bean).afterPropertiesSet();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (mbd != null &amp;&amp; bean.getClass() != NullBean.class) &#123;</span><br><span class="line">			String initMethodName = mbd.getInitMethodName();</span><br><span class="line">			if (StringUtils.hasLength(initMethodName) &amp;&amp;</span><br><span class="line">					!(isInitializingBean &amp;&amp; &quot;afterPropertiesSet&quot;.equals(initMethodName)) &amp;&amp;	</span><br><span class="line">					!mbd.isExternallyManagedInitMethod(initMethodName)) &#123;</span><br><span class="line">				invokeCustomInitMethod(beanName, bean, mbd);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>当bean=MapperFactoryBean的时候 先走父类DaoSupport的afterPropertiesSet：</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public abstract class DaoSupport implements InitializingBean &#123;</span><br><span class="line">...</span><br><span class="line">	@Override</span><br><span class="line">	public final void afterPropertiesSet() throws IllegalArgumentException, BeanInitializationException &#123;</span><br><span class="line">		// Let abstract subclasses check their configuration.</span><br><span class="line">		//检查dao的cfg</span><br><span class="line">		checkDaoConfig();</span><br><span class="line"></span><br><span class="line">		// Let concrete implementations initialize themselves.</span><br><span class="line">		try &#123;</span><br><span class="line">		//初始化加载dao 父类空实现</span><br><span class="line">			initDao();</span><br><span class="line">		&#125;</span><br><span class="line">		catch (Exception ex) &#123;</span><br><span class="line">			throw new BeanInitializationException(&quot;Initialization of DAO failed&quot;, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>  <strong>具体实现MapperFactoryBean：</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">package org.mybatis.spring.mapper;</span><br><span class="line"></span><br><span class="line">import static org.springframework.util.Assert.notNull;</span><br><span class="line"></span><br><span class="line">import org.apache.ibatis.executor.ErrorContext;</span><br><span class="line">import org.apache.ibatis.session.Configuration;</span><br><span class="line">import org.mybatis.spring.SqlSessionTemplate;</span><br><span class="line">import org.mybatis.spring.support.SqlSessionDaoSupport;</span><br><span class="line">import org.springframework.beans.factory.FactoryBean;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * BeanFactory that enables injection of MyBatis mapper interfaces. It can be set up with a</span><br><span class="line"> * SqlSessionFactory or a pre-configured SqlSessionTemplate.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * Sample configuration:</span><br><span class="line"> *</span><br><span class="line"> * &lt;pre class=&quot;code&quot;&gt;</span><br><span class="line"> * &#123;@code</span><br><span class="line"> *   &lt;bean id=&quot;baseMapper&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot; abstract=&quot;true&quot; lazy-init=&quot;true&quot;&gt;</span><br><span class="line"> *     &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span><br><span class="line"> *   &lt;/bean&gt;</span><br><span class="line"> *</span><br><span class="line"> *   &lt;bean id=&quot;oneMapper&quot; parent=&quot;baseMapper&quot;&gt;</span><br><span class="line"> *     &lt;property name=&quot;mapperInterface&quot; value=&quot;my.package.MyMapperInterface&quot; /&gt;</span><br><span class="line"> *   &lt;/bean&gt;</span><br><span class="line"> *</span><br><span class="line"> *   &lt;bean id=&quot;anotherMapper&quot; parent=&quot;baseMapper&quot;&gt;</span><br><span class="line"> *     &lt;property name=&quot;mapperInterface&quot; value=&quot;my.package.MyAnotherMapperInterface&quot; /&gt;</span><br><span class="line"> *   &lt;/bean&gt;</span><br><span class="line"> * &#125;</span><br><span class="line"> * &lt;/pre&gt;</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * Note that this factory can only inject &lt;em&gt;interfaces&lt;/em&gt;, not concrete classes.</span><br><span class="line"> *</span><br><span class="line"> * @author Eduardo Macarron</span><br><span class="line"> *</span><br><span class="line"> * @see SqlSessionTemplate</span><br><span class="line"> */</span><br><span class="line">public class MapperFactoryBean&lt;T&gt; extends SqlSessionDaoSupport implements FactoryBean&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">  private Class&lt;T&gt; mapperInterface;</span><br><span class="line"></span><br><span class="line">  private boolean addToConfig = true;</span><br><span class="line"></span><br><span class="line">  public MapperFactoryBean() &#123;</span><br><span class="line">    //intentionally empty </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  public MapperFactoryBean(Class&lt;T&gt; mapperInterface) &#123;</span><br><span class="line">    this.mapperInterface = mapperInterface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  protected void checkDaoConfig() &#123;</span><br><span class="line">  //进入父类DaoSupport的checkDaoConfig方法</span><br><span class="line">    super.checkDaoConfig();</span><br><span class="line"></span><br><span class="line">    notNull(this.mapperInterface, &quot;Property &apos;mapperInterface&apos; is required&quot;);</span><br><span class="line">	//获取到mybatis的configuration</span><br><span class="line">    Configuration configuration = getSqlSession().getConfiguration();</span><br><span class="line">    //如果配置中没有当前执行sql的dao</span><br><span class="line">    if (this.addToConfig &amp;&amp; !configuration.hasMapper(this.mapperInterface)) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">      //加入该dao到配置类中</span><br><span class="line">        configuration.addMapper(this.mapperInterface);</span><br><span class="line">      &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.error(&quot;Error while adding the mapper &apos;&quot; + this.mapperInterface + &quot;&apos; to configuration.&quot;, e);</span><br><span class="line">        throw new IllegalArgumentException(e);</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public T getObject() throws Exception &#123;</span><br><span class="line">    return getSqlSession().getMapper(this.mapperInterface);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public Class&lt;T&gt; getObjectType() &#123;</span><br><span class="line">    return this.mapperInterface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * &#123;@inheritDoc&#125;</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public boolean isSingleton() &#123;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //------------- mutators --------------</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Sets the mapper interface of the MyBatis mapper</span><br><span class="line">   *</span><br><span class="line">   * @param mapperInterface class of the interface</span><br><span class="line">   */</span><br><span class="line">  public void setMapperInterface(Class&lt;T&gt; mapperInterface) &#123;</span><br><span class="line">    this.mapperInterface = mapperInterface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Return the mapper interface of the MyBatis mapper</span><br><span class="line">   *</span><br><span class="line">   * @return class of the interface</span><br><span class="line">   */</span><br><span class="line">  public Class&lt;T&gt; getMapperInterface() &#123;</span><br><span class="line">    return mapperInterface;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * If addToConfig is false the mapper will not be added to MyBatis. This means</span><br><span class="line">   * it must have been included in mybatis-config.xml.</span><br><span class="line">   * &lt;p/&gt;</span><br><span class="line">   * If it is true, the mapper will be added to MyBatis in the case it is not already</span><br><span class="line">   * registered.</span><br><span class="line">   * &lt;p/&gt;</span><br><span class="line">   * By default addToCofig is true.</span><br><span class="line">   *</span><br><span class="line">   * @param addToConfig</span><br><span class="line">   */</span><br><span class="line">  public void setAddToConfig(boolean addToConfig) &#123;</span><br><span class="line">    this.addToConfig = addToConfig;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Return the flag for addition into MyBatis config.</span><br><span class="line">   *</span><br><span class="line">   * @return true if the mapper will be added to MyBatis in the case it is not already</span><br><span class="line">   * registered.</span><br><span class="line">   */</span><br><span class="line">  public boolean isAddToConfig() &#123;</span><br><span class="line">    return addToConfig;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>走完上面的代码，console打印日志：</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-11-07 23:51:11.500 INFO [restartedMain][Jdk14Logger.java:99] - Bean &apos;resourceDao&apos; of type [org.mybatis.spring.mapper.MapperFactoryBean] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)</span><br></pre></td></tr></table></figure>

<p>  *<em>那么底下会创建bean *</em></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory</span><br><span class="line">		implements AutowireCapableBeanFactory &#123;</span><br><span class="line">	...</span><br><span class="line">	@Override</span><br><span class="line">	protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span><br><span class="line">			throws BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">		if (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(&quot;Creating instance of bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		RootBeanDefinition mbdToUse = mbd;</span><br><span class="line"></span><br><span class="line">		// Make sure bean class is actually resolved at this point, and</span><br><span class="line">		// clone the bean definition in case of a dynamically resolved Class</span><br><span class="line">		// which cannot be stored in the shared merged bean definition.</span><br><span class="line">		Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</span><br><span class="line">		if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null) &#123;</span><br><span class="line">			mbdToUse = new RootBeanDefinition(mbd);</span><br><span class="line">			mbdToUse.setBeanClass(resolvedClass);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Prepare method overrides.</span><br><span class="line">		try &#123;</span><br><span class="line">			mbdToUse.prepareMethodOverrides();</span><br><span class="line">		&#125;</span><br><span class="line">		catch (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">			throw new BeanDefinitionStoreException(mbdToUse.getResourceDescription(),</span><br><span class="line">					beanName, &quot;Validation of method overrides failed&quot;, ex);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		try &#123;</span><br><span class="line">			// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span><br><span class="line">			Object bean = resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">			if (bean != null) &#123;</span><br><span class="line">				return bean;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (Throwable ex) &#123;</span><br><span class="line">			throw new BeanCreationException(mbdToUse.getResourceDescription(), beanName,</span><br><span class="line">					&quot;BeanPostProcessor before instantiation of bean failed&quot;, ex);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		try &#123;</span><br><span class="line">		//创建bean</span><br><span class="line">			Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Finished creating instance of bean &apos;&quot; + beanName + &quot;&apos;&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			return beanInstance;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;</span><br><span class="line">			// A previously detected exception with proper bean creation context already,</span><br><span class="line">			// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span><br><span class="line">			throw ex;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (Throwable ex) &#123;</span><br><span class="line">			throw new BeanCreationException(</span><br><span class="line">					mbdToUse.getResourceDescription(), beanName, &quot;Unexpected exception during bean creation&quot;, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	//doCreateBean 创建bean</span><br><span class="line">		protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args)</span><br><span class="line">			throws BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">		// Instantiate the bean.</span><br><span class="line">		BeanWrapper instanceWrapper = null;</span><br><span class="line">		if (mbd.isSingleton()) &#123;</span><br><span class="line">			instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">		if (instanceWrapper == null) &#123;</span><br><span class="line">			instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">		&#125;</span><br><span class="line">		final Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">		Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">		if (beanType != NullBean.class) &#123;</span><br><span class="line">			mbd.resolvedTargetType = beanType;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Allow post-processors to modify the merged bean definition.</span><br><span class="line">		synchronized (mbd.postProcessingLock) &#123;</span><br><span class="line">			if (!mbd.postProcessed) &#123;</span><br><span class="line">				try &#123;</span><br><span class="line">					applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">				&#125;</span><br><span class="line">				catch (Throwable ex) &#123;</span><br><span class="line">					throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br><span class="line">							&quot;Post-processing of merged bean definition failed&quot;, ex);</span><br><span class="line">				&#125;</span><br><span class="line">				mbd.postProcessed = true;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Eagerly cache singletons to be able to resolve circular references</span><br><span class="line">		// even when triggered by lifecycle interfaces like BeanFactoryAware.</span><br><span class="line">		boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp;</span><br><span class="line">				isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">		if (earlySingletonExposure) &#123;</span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Eagerly caching bean &apos;&quot; + beanName +</span><br><span class="line">						&quot;&apos; to allow for resolving potential circular references&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Initialize the bean instance.</span><br><span class="line">		Object exposedObject = bean;</span><br><span class="line">		try &#123;</span><br><span class="line">			populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">			exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">		&#125;</span><br><span class="line">		catch (Throwable ex) &#123;</span><br><span class="line">			if (ex instanceof BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">				throw (BeanCreationException) ex;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				throw new BeanCreationException(</span><br><span class="line">						mbd.getResourceDescription(), beanName, &quot;Initialization of bean failed&quot;, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		if (earlySingletonExposure) &#123;</span><br><span class="line">			Object earlySingletonReference = getSingleton(beanName, false);</span><br><span class="line">			if (earlySingletonReference != null) &#123;</span><br><span class="line">				if (exposedObject == bean) &#123;</span><br><span class="line">					exposedObject = earlySingletonReference;</span><br><span class="line">				&#125;</span><br><span class="line">				else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">					String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">					Set&lt;String&gt; actualDependentBeans = new LinkedHashSet&lt;&gt;(dependentBeans.length);</span><br><span class="line">					for (String dependentBean : dependentBeans) &#123;</span><br><span class="line">						if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">							actualDependentBeans.add(dependentBean);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					if (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">						throw new BeanCurrentlyInCreationException(beanName,</span><br><span class="line">								&quot;Bean with name &apos;&quot; + beanName + &quot;&apos; has been injected into other beans [&quot; +</span><br><span class="line">								StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</span><br><span class="line">								&quot;] in its raw version as part of a circular reference, but has eventually been &quot; +</span><br><span class="line">								&quot;wrapped. This means that said other beans do not use the final version of the &quot; +</span><br><span class="line">								&quot;bean. This is often the result of over-eager type matching - consider using &quot; +</span><br><span class="line">								&quot;&apos;getBeanNamesOfType&apos; with the &apos;allowEagerInit&apos; flag turned off, for example.&quot;);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Register bean as disposable </span><br><span class="line">		//将这个dao注册为一次性的bean</span><br><span class="line">		try &#123;</span><br><span class="line">			registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">		&#125;</span><br><span class="line">		catch (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">			throw new BeanCreationException(</span><br><span class="line">					mbd.getResourceDescription(), beanName, &quot;Invalid destruction signature&quot;, ex);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		return exposedObject;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>//注册为单例</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">	public abstract class AbstractBeanFactory extends FactoryBeanRegistrySupport implements ConfigurableBeanFactory &#123;</span><br><span class="line">...</span><br><span class="line">	/**</span><br><span class="line">	 * Add the given bean to the list of disposable beans in this factory,</span><br><span class="line">	 * registering its DisposableBean interface and/or the given destroy method</span><br><span class="line">	 * to be called on factory shutdown (if applicable). Only applies to singletons.</span><br><span class="line">	 * @param beanName the name of the bean</span><br><span class="line">	 * @param bean the bean instance</span><br><span class="line">	 * @param mbd the bean definition for the bean</span><br><span class="line">	 * @see RootBeanDefinition#isSingleton</span><br><span class="line">	 * @see RootBeanDefinition#getDependsOn</span><br><span class="line">	 * @see #registerDisposableBean</span><br><span class="line">	 * @see #registerDependentBean</span><br><span class="line">	 */</span><br><span class="line">	protected void registerDisposableBeanIfNecessary(String beanName, Object bean, RootBeanDefinition mbd) &#123;</span><br><span class="line">		AccessControlContext acc = (System.getSecurityManager() != null ? getAccessControlContext() : null);</span><br><span class="line">		if (!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd)) &#123;</span><br><span class="line">			if (mbd.isSingleton()) &#123;</span><br><span class="line">				// Register a DisposableBean implementation that performs all destruction</span><br><span class="line">				// work for the given bean: DestructionAwareBeanPostProcessors,</span><br><span class="line">				// DisposableBean interface, custom destroy method.</span><br><span class="line">				registerDisposableBean(beanName,</span><br><span class="line">						new DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc));</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				// A bean with a custom scope...</span><br><span class="line">				Scope scope = this.scopes.get(mbd.getScope());</span><br><span class="line">				if (scope == null) &#123;</span><br><span class="line">					throw new IllegalStateException(&quot;No Scope registered for scope name &apos;&quot; + mbd.getScope() + &quot;&apos;&quot;);</span><br><span class="line">				&#125;</span><br><span class="line">				scope.registerDestructionCallback(beanName,</span><br><span class="line">						new DisposableBeanAdapter(bean, beanName, mbd, getBeanPostProcessors(), acc));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>当要执行dao层的sql操作时候</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.ibatis.binding.MapperProxy@14e19901</span><br></pre></td></tr></table></figure>

<p>  <strong>这个是一个代理类</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *    Copyright 2009-2017 the original author or authors.</span><br><span class="line"> *</span><br><span class="line"> *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> *    you may not use this file except in compliance with the License.</span><br><span class="line"> *    You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *       http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> *    Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> *    See the License for the specific language governing permissions and</span><br><span class="line"> *    limitations under the License.</span><br><span class="line"> */</span><br><span class="line">package org.apache.ibatis.binding;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.lang.invoke.MethodHandles;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Modifier;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import org.apache.ibatis.lang.UsesJava7;</span><br><span class="line">import org.apache.ibatis.reflection.ExceptionUtil;</span><br><span class="line">import org.apache.ibatis.session.SqlSession;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author Clinton Begin</span><br><span class="line"> * @author Eduardo Macarron</span><br><span class="line"> */</span><br><span class="line">public class MapperProxy&lt;T&gt; implements InvocationHandler, Serializable &#123;</span><br><span class="line"></span><br><span class="line">  private static final long serialVersionUID = -6424540398559729838L;</span><br><span class="line">  private final SqlSession sqlSession;</span><br><span class="line">  private final Class&lt;T&gt; mapperInterface;</span><br><span class="line">  private final Map&lt;Method, MapperMethod&gt; methodCache;</span><br><span class="line"></span><br><span class="line">  public MapperProxy(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperMethod&gt; methodCache) &#123;</span><br><span class="line">    this.sqlSession = sqlSession;</span><br><span class="line">    this.mapperInterface = mapperInterface;</span><br><span class="line">    this.methodCache = methodCache;</span><br><span class="line">  &#125;</span><br><span class="line">  //具体的sql操作会走这里</span><br><span class="line">  @Override</span><br><span class="line">  public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">    //判断是否是生命的类</span><br><span class="line">      if (Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class="line">        return method.invoke(this, args);</span><br><span class="line">        //是否是原生方法</span><br><span class="line">      &#125; else if (isDefaultMethod(method)) &#123;</span><br><span class="line">        return invokeDefaultMethod(proxy, method, args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (Throwable t) &#123;</span><br><span class="line">      throw ExceptionUtil.unwrapThrowable(t);</span><br><span class="line">    &#125;</span><br><span class="line">    //将具体的sql操作缓存并返回</span><br><span class="line">    final MapperMethod mapperMethod = cachedMapperMethod(method);</span><br><span class="line">    //进行执行</span><br><span class="line">    return mapperMethod.execute(sqlSession, args);</span><br><span class="line">  &#125;</span><br><span class="line"> //将具体的sql操作method缓存</span><br><span class="line">  private MapperMethod cachedMapperMethod(Method method) &#123;</span><br><span class="line">    MapperMethod mapperMethod = methodCache.get(method);</span><br><span class="line">    if (mapperMethod == null) &#123;</span><br><span class="line">      mapperMethod = new MapperMethod(mapperInterface, method, sqlSession.getConfiguration());</span><br><span class="line">      methodCache.put(method, mapperMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    return mapperMethod;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @UsesJava7</span><br><span class="line">  private Object invokeDefaultMethod(Object proxy, Method method, Object[] args)</span><br><span class="line">      throws Throwable &#123;</span><br><span class="line">    final Constructor&lt;MethodHandles.Lookup&gt; constructor = MethodHandles.Lookup.class</span><br><span class="line">        .getDeclaredConstructor(Class.class, int.class);</span><br><span class="line">    if (!constructor.isAccessible()) &#123;</span><br><span class="line">      constructor.setAccessible(true);</span><br><span class="line">    &#125;</span><br><span class="line">    final Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br><span class="line">    return constructor</span><br><span class="line">        .newInstance(declaringClass,</span><br><span class="line">            MethodHandles.Lookup.PRIVATE | MethodHandles.Lookup.PROTECTED</span><br><span class="line">                | MethodHandles.Lookup.PACKAGE | MethodHandles.Lookup.PUBLIC)</span><br><span class="line">        .unreflectSpecial(method, declaringClass).bindTo(proxy).invokeWithArguments(args);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Backport of java.lang.reflect.Method#isDefault()</span><br><span class="line">   */</span><br><span class="line">  private boolean isDefaultMethod(Method method) &#123;</span><br><span class="line">    return ((method.getModifiers()</span><br><span class="line">        &amp; (Modifier.ABSTRACT | Modifier.PUBLIC | Modifier.STATIC)) == Modifier.PUBLIC)</span><br><span class="line">        &amp;&amp; method.getDeclaringClass().isInterface();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>MapperMethod:</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line">public class MapperMethod &#123;</span><br><span class="line"></span><br><span class="line">  private final SqlCommand command;</span><br><span class="line">  private final MethodSignature method;</span><br><span class="line"></span><br><span class="line">  public MapperMethod(Class&lt;?&gt; mapperInterface, Method method, Configuration config) &#123;</span><br><span class="line">    this.command = new SqlCommand(config, mapperInterface, method);</span><br><span class="line">    this.method = new MethodSignature(config, mapperInterface, method);</span><br><span class="line">  &#125;</span><br><span class="line"> //这里进行执行sql</span><br><span class="line">  public Object execute(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    Object result;</span><br><span class="line">    //判断crud操作</span><br><span class="line">    switch (command.getType()) &#123;</span><br><span class="line">      case INSERT: &#123;</span><br><span class="line">    	Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.insert(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case UPDATE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.update(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case DELETE: &#123;</span><br><span class="line">        Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">        result = rowCountResult(sqlSession.delete(command.getName(), param));</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      case SELECT:</span><br><span class="line">        if (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;</span><br><span class="line">          executeWithResultHandler(sqlSession, args);</span><br><span class="line">          result = null;</span><br><span class="line">        &#125; else if (method.returnsMany()) &#123;</span><br><span class="line">        //这里是一个many的result跳到这里</span><br><span class="line">          result = executeForMany(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsMap()) &#123;</span><br><span class="line">          result = executeForMap(sqlSession, args);</span><br><span class="line">        &#125; else if (method.returnsCursor()) &#123;</span><br><span class="line">          result = executeForCursor(sqlSession, args);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">          result = sqlSession.selectOne(command.getName(), param);</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">      case FLUSH:</span><br><span class="line">        result = sqlSession.flushStatements();</span><br><span class="line">        break;</span><br><span class="line">      default:</span><br><span class="line">        throw new BindingException(&quot;Unknown execution method for: &quot; + command.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    if (result == null &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;</span><br><span class="line">      throw new BindingException(&quot;Mapper method &apos;&quot; + command.getName() </span><br><span class="line">          + &quot; attempted to return null from a method with a primitive return type (&quot; + method.getReturnType() + &quot;).&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private Object rowCountResult(int rowCount) &#123;</span><br><span class="line">    final Object result;</span><br><span class="line">    if (method.returnsVoid()) &#123;</span><br><span class="line">      result = null;</span><br><span class="line">    &#125; else if (Integer.class.equals(method.getReturnType()) || Integer.TYPE.equals(method.getReturnType())) &#123;</span><br><span class="line">      result = rowCount;</span><br><span class="line">    &#125; else if (Long.class.equals(method.getReturnType()) || Long.TYPE.equals(method.getReturnType())) &#123;</span><br><span class="line">      result = (long)rowCount;</span><br><span class="line">    &#125; else if (Boolean.class.equals(method.getReturnType()) || Boolean.TYPE.equals(method.getReturnType())) &#123;</span><br><span class="line">      result = rowCount &gt; 0;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      throw new BindingException(&quot;Mapper method &apos;&quot; + command.getName() + &quot;&apos; has an unsupported return type: &quot; + method.getReturnType());</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private void executeWithResultHandler(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    MappedStatement ms = sqlSession.getConfiguration().getMappedStatement(command.getName());</span><br><span class="line">    if (void.class.equals(ms.getResultMaps().get(0).getType())) &#123;</span><br><span class="line">      throw new BindingException(&quot;method &quot; + command.getName() </span><br><span class="line">          + &quot; needs either a @ResultMap annotation, a @ResultType annotation,&quot; </span><br><span class="line">          + &quot; or a resultType attribute in XML so a ResultHandler can be used as a parameter.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">    if (method.hasRowBounds()) &#123;</span><br><span class="line">      RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">      sqlSession.select(command.getName(), param, rowBounds, method.extractResultHandler(args));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      sqlSession.select(command.getName(), param, method.extractResultHandler(args));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	//多结果集的跳到这里</span><br><span class="line">  private &lt;E&gt; Object executeForMany(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    List&lt;E&gt; result;</span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">    if (method.hasRowBounds()) &#123;</span><br><span class="line">      RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">      //重点 交给sqlSession进行处理</span><br><span class="line">      result = sqlSession.&lt;E&gt;selectList(command.getName(), param, rowBounds);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      result = sqlSession.&lt;E&gt;selectList(command.getName(), param);</span><br><span class="line">    &#125;</span><br><span class="line">    // issue #510 Collections &amp; arrays support</span><br><span class="line">    if (!method.getReturnType().isAssignableFrom(result.getClass())) &#123;</span><br><span class="line">      if (method.getReturnType().isArray()) &#123;</span><br><span class="line">        return convertToArray(result);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return convertToDeclaredCollection(sqlSession.getConfiguration(), result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private &lt;T&gt; Cursor&lt;T&gt; executeForCursor(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    Cursor&lt;T&gt; result;</span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">    if (method.hasRowBounds()) &#123;</span><br><span class="line">      RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">      result = sqlSession.&lt;T&gt;selectCursor(command.getName(), param, rowBounds);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      result = sqlSession.&lt;T&gt;selectCursor(command.getName(), param);</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private &lt;E&gt; Object convertToDeclaredCollection(Configuration config, List&lt;E&gt; list) &#123;</span><br><span class="line">    Object collection = config.getObjectFactory().create(method.getReturnType());</span><br><span class="line">    MetaObject metaObject = config.newMetaObject(collection);</span><br><span class="line">    metaObject.addAll(list);</span><br><span class="line">    return collection;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">  private &lt;E&gt; Object convertToArray(List&lt;E&gt; list) &#123;</span><br><span class="line">    Class&lt;?&gt; arrayComponentType = method.getReturnType().getComponentType();</span><br><span class="line">    Object array = Array.newInstance(arrayComponentType, list.size());</span><br><span class="line">    if (arrayComponentType.isPrimitive()) &#123;</span><br><span class="line">      for (int i = 0; i &lt; list.size(); i++) &#123;</span><br><span class="line">        Array.set(array, i, list.get(i));</span><br><span class="line">      &#125;</span><br><span class="line">      return array;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return list.toArray((E[])array);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private &lt;K, V&gt; Map&lt;K, V&gt; executeForMap(SqlSession sqlSession, Object[] args) &#123;</span><br><span class="line">    Map&lt;K, V&gt; result;</span><br><span class="line">    Object param = method.convertArgsToSqlCommandParam(args);</span><br><span class="line">    if (method.hasRowBounds()) &#123;</span><br><span class="line">      RowBounds rowBounds = method.extractRowBounds(args);</span><br><span class="line">      result = sqlSession.&lt;K, V&gt;selectMap(command.getName(), param, method.getMapKey(), rowBounds);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      result = sqlSession.&lt;K, V&gt;selectMap(command.getName(), param, method.getMapKey());</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public static class ParamMap&lt;V&gt; extends HashMap&lt;String, V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = -2212268410512043556L;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public V get(Object key) &#123;</span><br><span class="line">      if (!super.containsKey(key)) &#123;</span><br><span class="line">        throw new BindingException(&quot;Parameter &apos;&quot; + key + &quot;&apos; not found. Available parameters are &quot; + keySet());</span><br><span class="line">      &#125;</span><br><span class="line">      return super.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public static class SqlCommand &#123;</span><br><span class="line"></span><br><span class="line">    private final String name;</span><br><span class="line">    private final SqlCommandType type;</span><br><span class="line"></span><br><span class="line">    public SqlCommand(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method) &#123;</span><br><span class="line">      final String methodName = method.getName();</span><br><span class="line">      final Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br><span class="line">      MappedStatement ms = resolveMappedStatement(mapperInterface, methodName, declaringClass,</span><br><span class="line">          configuration);</span><br><span class="line">      if (ms == null) &#123;</span><br><span class="line">        if (method.getAnnotation(Flush.class) != null) &#123;</span><br><span class="line">          name = null;</span><br><span class="line">          type = SqlCommandType.FLUSH;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          throw new BindingException(&quot;Invalid bound statement (not found): &quot;</span><br><span class="line">              + mapperInterface.getName() + &quot;.&quot; + methodName);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        name = ms.getId();</span><br><span class="line">        type = ms.getSqlCommandType();</span><br><span class="line">        if (type == SqlCommandType.UNKNOWN) &#123;</span><br><span class="line">          throw new BindingException(&quot;Unknown execution method for: &quot; + name);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">      return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public SqlCommandType getType() &#123;</span><br><span class="line">      return type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private MappedStatement resolveMappedStatement(Class&lt;?&gt; mapperInterface, String methodName,</span><br><span class="line">        Class&lt;?&gt; declaringClass, Configuration configuration) &#123;</span><br><span class="line">      String statementId = mapperInterface.getName() + &quot;.&quot; + methodName;</span><br><span class="line">      if (configuration.hasStatement(statementId)) &#123;</span><br><span class="line">        return configuration.getMappedStatement(statementId);</span><br><span class="line">      &#125; else if (mapperInterface.equals(declaringClass)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">      &#125;</span><br><span class="line">      for (Class&lt;?&gt; superInterface : mapperInterface.getInterfaces()) &#123;</span><br><span class="line">        if (declaringClass.isAssignableFrom(superInterface)) &#123;</span><br><span class="line">          MappedStatement ms = resolveMappedStatement(superInterface, methodName,</span><br><span class="line">              declaringClass, configuration);</span><br><span class="line">          if (ms != null) &#123;</span><br><span class="line">            return ms;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return null;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public static class MethodSignature &#123;</span><br><span class="line"></span><br><span class="line">    private final boolean returnsMany;</span><br><span class="line">    private final boolean returnsMap;</span><br><span class="line">    private final boolean returnsVoid;</span><br><span class="line">    private final boolean returnsCursor;</span><br><span class="line">    private final Class&lt;?&gt; returnType;</span><br><span class="line">    private final String mapKey;</span><br><span class="line">    private final Integer resultHandlerIndex;</span><br><span class="line">    private final Integer rowBoundsIndex;</span><br><span class="line">    private final ParamNameResolver paramNameResolver;</span><br><span class="line"></span><br><span class="line">    public MethodSignature(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method) &#123;</span><br><span class="line">      Type resolvedReturnType = TypeParameterResolver.resolveReturnType(method, mapperInterface);</span><br><span class="line">      if (resolvedReturnType instanceof Class&lt;?&gt;) &#123;</span><br><span class="line">        this.returnType = (Class&lt;?&gt;) resolvedReturnType;</span><br><span class="line">      &#125; else if (resolvedReturnType instanceof ParameterizedType) &#123;</span><br><span class="line">        this.returnType = (Class&lt;?&gt;) ((ParameterizedType) resolvedReturnType).getRawType();</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        this.returnType = method.getReturnType();</span><br><span class="line">      &#125;</span><br><span class="line">      this.returnsVoid = void.class.equals(this.returnType);</span><br><span class="line">      this.returnsMany = (configuration.getObjectFactory().isCollection(this.returnType) || this.returnType.isArray());</span><br><span class="line">      this.returnsCursor = Cursor.class.equals(this.returnType);</span><br><span class="line">      this.mapKey = getMapKey(method);</span><br><span class="line">      this.returnsMap = (this.mapKey != null);</span><br><span class="line">      this.rowBoundsIndex = getUniqueParamIndex(method, RowBounds.class);</span><br><span class="line">      this.resultHandlerIndex = getUniqueParamIndex(method, ResultHandler.class);</span><br><span class="line">      this.paramNameResolver = new ParamNameResolver(configuration, method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object convertArgsToSqlCommandParam(Object[] args) &#123;</span><br><span class="line">      return paramNameResolver.getNamedParams(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean hasRowBounds() &#123;</span><br><span class="line">      return rowBoundsIndex != null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public RowBounds extractRowBounds(Object[] args) &#123;</span><br><span class="line">      return hasRowBounds() ? (RowBounds) args[rowBoundsIndex] : null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean hasResultHandler() &#123;</span><br><span class="line">      return resultHandlerIndex != null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public ResultHandler extractResultHandler(Object[] args) &#123;</span><br><span class="line">      return hasResultHandler() ? (ResultHandler) args[resultHandlerIndex] : null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getMapKey() &#123;</span><br><span class="line">      return mapKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Class&lt;?&gt; getReturnType() &#123;</span><br><span class="line">      return returnType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean returnsMany() &#123;</span><br><span class="line">      return returnsMany;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean returnsMap() &#123;</span><br><span class="line">      return returnsMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean returnsVoid() &#123;</span><br><span class="line">      return returnsVoid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean returnsCursor() &#123;</span><br><span class="line">      return returnsCursor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Integer getUniqueParamIndex(Method method, Class&lt;?&gt; paramType) &#123;</span><br><span class="line">      Integer index = null;</span><br><span class="line">      final Class&lt;?&gt;[] argTypes = method.getParameterTypes();</span><br><span class="line">      for (int i = 0; i &lt; argTypes.length; i++) &#123;</span><br><span class="line">        if (paramType.isAssignableFrom(argTypes[i])) &#123;</span><br><span class="line">          if (index == null) &#123;</span><br><span class="line">            index = i;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            throw new BindingException(method.getName() + &quot; cannot have multiple &quot; + paramType.getSimpleName() + &quot; parameters&quot;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String getMapKey(Method method) &#123;</span><br><span class="line">      String mapKey = null;</span><br><span class="line">      if (Map.class.isAssignableFrom(method.getReturnType())) &#123;</span><br><span class="line">        final MapKey mapKeyAnnotation = method.getAnnotation(MapKey.class);</span><br><span class="line">        if (mapKeyAnnotation != null) &#123;</span><br><span class="line">          mapKey = mapKeyAnnotation.value();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return mapKey;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  *<em>上述的sqlsession的操作跳到 DefaultSqlSession *</em></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class DefaultSqlSession implements SqlSession &#123;</span><br><span class="line">...</span><br><span class="line">  @Override</span><br><span class="line">  public &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter) &#123;</span><br><span class="line">    return this.selectList(statement, parameter, RowBounds.DEFAULT);</span><br><span class="line">  &#125;</span><br><span class="line">  @Override</span><br><span class="line">  public &lt;E&gt; List&lt;E&gt; selectList(String statement, Object parameter, RowBounds rowBounds) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">    //根据语句statement拿到MappedStatement</span><br><span class="line">      MappedStatement ms = configuration.getMappedStatement(statement);</span><br><span class="line">      //重点来了 executor执行器来执行具体的sql</span><br><span class="line">      return ,executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">      throw ExceptionFactory.wrapException(&quot;Error querying database.  Cause: &quot; + e, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>executor有两个实现：BaseExecutor 和CachingExecutor</strong></p>
<p>  <strong>这里走CachingExecutor：</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class CachingExecutor implements Executor &#123;</span><br><span class="line">...</span><br><span class="line">  @Override</span><br><span class="line">  public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException &#123;</span><br><span class="line">  //拿到sql boundSql里面存储有要执行的sql</span><br><span class="line">    BoundSql boundSql = ms.getBoundSql(parameterObject);</span><br><span class="line">    CacheKey key = createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class="line">    //返回具体的query方法的执行结果集</span><br><span class="line">    return query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">  &#125;</span><br><span class="line">  //缓存sql</span><br><span class="line">    @Override</span><br><span class="line">  public CacheKey createCacheKey(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql) &#123;</span><br><span class="line">      //没有的话走BaseExecutor</span><br><span class="line">    return delegate.createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class="line">  &#125;</span><br><span class="line">  //具体的query方法</span><br><span class="line">    @Override</span><br><span class="line">  public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span><br><span class="line">      throws SQLException &#123;</span><br><span class="line">    Cache cache = ms.getCache();</span><br><span class="line">    //这里用到缓存 看之前是否用过sql查询 有的话酒从缓存拿了</span><br><span class="line">    if (cache != null) &#123;</span><br><span class="line">      flushCacheIfRequired(ms);</span><br><span class="line">      if (ms.isUseCache() &amp;&amp; resultHandler == null) &#123;</span><br><span class="line">        ensureNoOutParams(ms, parameterObject, boundSql);</span><br><span class="line">        @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">        List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">        if (list == null) &#123;</span><br><span class="line">          list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">          tcm.putObject(cache, key, list); // issue #578 and #116</span><br><span class="line">        &#125;</span><br><span class="line">        return list;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有的话走BaseExecutor</span><br><span class="line">    return delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>BaseExecutor：</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">//如果没有缓存走这里的query</span><br><span class="line">@SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">  @Override</span><br><span class="line">  public &lt;E&gt; List&lt;E&gt; query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(&quot;executing a query&quot;).object(ms.getId());</span><br><span class="line">    if (closed) &#123;</span><br><span class="line">      throw new ExecutorException(&quot;Executor was closed.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (queryStack == 0 &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">      clearLocalCache();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    try &#123;</span><br><span class="line">      queryStack++;</span><br><span class="line">      list = resultHandler == null ? (List&lt;E&gt;) localCache.getObject(key) : null;</span><br><span class="line">      if (list != null) &#123;</span><br><span class="line">        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      queryStack--;</span><br><span class="line">    &#125;</span><br><span class="line">    if (queryStack == 0) &#123;</span><br><span class="line">      for (DeferredLoad deferredLoad : deferredLoads) &#123;</span><br><span class="line">        deferredLoad.load();</span><br><span class="line">      &#125;</span><br><span class="line">      // issue #601</span><br><span class="line">      deferredLoads.clear();</span><br><span class="line">      if (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</span><br><span class="line">        // issue #482</span><br><span class="line">        clearLocalCache();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //再往里的queryFromDatabase</span><br><span class="line">  private &lt;E&gt; List&lt;E&gt; queryFromDatabase(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException &#123;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    localCache.putObject(key, EXECUTION_PLACEHOLDER);</span><br><span class="line">    try &#123;</span><br><span class="line">    //这里再次跳转 走SimpleExecutor</span><br><span class="line">      list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      localCache.removeObject(key);</span><br><span class="line">    &#125;</span><br><span class="line">    localCache.putObject(key, list);</span><br><span class="line">    if (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class="line">      localOutputParameterCache.putObject(key, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">    return list;</span><br><span class="line">  &#125;</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>SimpleExecutor:类似的类还有ReuseExecutor，ClosedExecutor，BatchExecutor 都是BaseExecutor的子类</strong></p>
<p>  <strong>值得一提的是再openSessionFromConnection或openSessionFromConnection的时候就会创建一个新的executor并制定类型:</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public Executor newExecutor(Transaction transaction, ExecutorType executorType) &#123;</span><br><span class="line">  executorType = executorType == null ? defaultExecutorType : executorType;</span><br><span class="line">  executorType = executorType == null ? ExecutorType.SIMPLE : executorType;</span><br><span class="line">  Executor executor;</span><br><span class="line">  if (ExecutorType.BATCH == executorType) &#123;</span><br><span class="line">    executor = new BatchExecutor(this, transaction);</span><br><span class="line">  &#125; else if (ExecutorType.REUSE == executorType) &#123;</span><br><span class="line">    executor = new ReuseExecutor(this, transaction);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    executor = new SimpleExecutor(this, transaction);</span><br><span class="line">  &#125;</span><br><span class="line">  if (cacheEnabled) &#123;</span><br><span class="line">    executor = new CachingExecutor(executor);</span><br><span class="line">  &#125;</span><br><span class="line">  executor = (Executor) interceptorChain.pluginAll(executor);</span><br><span class="line">  return executor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public &lt;E&gt; List&lt;E&gt; doQuery(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql) throws SQLException &#123;</span><br><span class="line">  Statement stmt = null;</span><br><span class="line">  try &#123;</span><br><span class="line">    Configuration configuration = ms.getConfiguration();</span><br><span class="line">   //获得一个StatementHandler</span><br><span class="line">    StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">   //进行预编译sql</span><br><span class="line">    stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">    //交给handler去执行</span><br><span class="line">    return handler.&lt;E&gt;query(stmt, resultHandler);</span><br><span class="line">  &#125; finally &#123;</span><br><span class="line">    closeStatement(stmt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">      //进行预编译sql</span><br><span class="line">  private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException &#123;</span><br><span class="line">  Statement stmt;</span><br><span class="line">  Connection connection = getConnection(statementLog);</span><br><span class="line">  stmt = handler.prepare(connection, transaction.getTimeout());</span><br><span class="line">  handler.parameterize(stmt);</span><br><span class="line">  return stmt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>交给StatementHandler去执行了,有几个实现类：这里走的PreparedStatementHandler</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> public class PreparedStatementHandler extends BaseStatementHandler &#123;</span><br><span class="line">...</span><br><span class="line"> @Override</span><br><span class="line">  public &lt;E&gt; List&lt;E&gt; query(Statement statement, ResultHandler resultHandler) throws SQLException &#123;</span><br><span class="line">    PreparedStatement ps = (PreparedStatement) statement;</span><br><span class="line">    ps.execute();</span><br><span class="line">    return resultSetHandler.&lt;E&gt; handleResultSets(ps);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>最后交给DefaultResultSetHandler来做</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public class DefaultResultSetHandler implements ResultSetHandler &#123;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public List&lt;Object&gt; handleResultSets(Statement stmt) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().activity(&quot;handling results&quot;).object(mappedStatement.getId());</span><br><span class="line"></span><br><span class="line">    final List&lt;Object&gt; multipleResults = new ArrayList&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">    int resultSetCount = 0;</span><br><span class="line">    ResultSetWrapper rsw = getFirstResultSet(stmt);</span><br><span class="line"></span><br><span class="line">    List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();</span><br><span class="line">    int resultMapCount = resultMaps.size();</span><br><span class="line">    validateResultMapsCount(rsw, resultMapCount);</span><br><span class="line">    while (rsw != null &amp;&amp; resultMapCount &gt; resultSetCount) &#123;</span><br><span class="line">      ResultMap resultMap = resultMaps.get(resultSetCount);</span><br><span class="line">      handleResultSet(rsw, resultMap, multipleResults, null);</span><br><span class="line">      rsw = getNextResultSet(stmt);</span><br><span class="line">      cleanUpAfterHandlingResultSet();</span><br><span class="line">      resultSetCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String[] resultSets = mappedStatement.getResultSets();</span><br><span class="line">    if (resultSets != null) &#123;</span><br><span class="line">      while (rsw != null &amp;&amp; resultSetCount &lt; resultSets.length) &#123;</span><br><span class="line">        ResultMapping parentMapping = nextResultMaps.get(resultSets[resultSetCount]);</span><br><span class="line">        if (parentMapping != null) &#123;</span><br><span class="line">          String nestedResultMapId = parentMapping.getNestedResultMapId();</span><br><span class="line">          ResultMap resultMap = configuration.getResultMap(nestedResultMapId);</span><br><span class="line">          handleResultSet(rsw, resultMap, null, parentMapping);</span><br><span class="line">        &#125;</span><br><span class="line">        rsw = getNextResultSet(stmt);</span><br><span class="line">        cleanUpAfterHandlingResultSet();</span><br><span class="line">        resultSetCount++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return collapseSingleResultList(multipleResults);</span><br><span class="line">  &#125;</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">  private List&lt;Object&gt; collapseSingleResultList(List&lt;Object&gt; multipleResults) &#123;</span><br><span class="line">    return multipleResults.size() == 1 ? (List&lt;Object&gt;) multipleResults.get(0) : multipleResults;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>整体流程</strong></p>
<p>  <strong>Mapper.selectOne()–&gt;MapperProxy.invoke–&gt;mapperMethod–&gt;SqlSession.selectOne–&gt;Executor.query()–&gt;SimpleExecutor.doQuery–&gt;PreparedStatementHandler.query–&gt;DefaultResultSetHandler.query</strong></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Mybatis/" rel="tag"># Mybatis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/02/Docker（一）/" rel="next" title="Docker（一）">
                <i class="fa fa-chevron-left"></i> Docker（一）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/02/Pulsar简介/" rel="prev" title="Pulsar简介">
                Pulsar简介 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/p829173265.jpg" alt="Andreby">
          <p class="site-author-name" itemprop="name">Andreby</p>
           
              <p class="site-description motion-element" itemprop="description">如果有什么需要明天做的事 最好现在开始做</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">59</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Andreby</span>
</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
