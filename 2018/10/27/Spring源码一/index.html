<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Spring,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1">






<meta name="description" content="Spring源码(1)">
<meta name="keywords" content="Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring源码一">
<meta property="og:url" content="http://yoursite.com/2018/10/27/Spring源码一/index.html">
<meta property="og:site_name" content="Andreby的随记">
<meta property="og:description" content="Spring源码(1)">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-01-22T11:07:38.453Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring源码一">
<meta name="twitter:description" content="Spring源码(1)">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/10/27/Spring源码一/">





  <title>Spring源码一 | Andreby的随记</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Andreby的随记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">如果有什么需要明天做的事 最好现在开始做</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/27/Spring源码一/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Andreby">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/p829173265.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Andreby的随记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring源码一</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-27T11:22:12+08:00">
                2018-10-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Spring源码(1)<a id="more"></a></p>
<h4 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h4><p>写的比较匆忙 ，结合Ctrl+F进行寻找关键字进行查询是最妙的。</p>
<ul>
<li><p>下载源码</p>
<p>首先从github上下载源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clonehttps://github.com/spring-projects/spring-framework.git spring-framework</span><br></pre></td></tr></table></figure>

<p>你也可以用SourceTree (一个界面化的git工具) 来管理你的git项目</p>
</li>
<li><p>下载gradle</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://gradle.org/</span><br></pre></td></tr></table></figure>

<p>下载完之后需要进行环境变量的配置</p>
<ul>
<li><p>在环境变量中配置<code>GRADLE_HOME=D:\ENV\gradle-4.10.2-bin\gradle-4.10.2</code></p>
</li>
<li><p>添加path变量 <code>%GRADLE_HOME%\bin</code></p>
</li>
<li><p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\andreby\Desktop&gt; gradle -version</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Gradle 4.10.2</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Build time:   2018-09-19 18:10:15 UTC</span><br><span class="line">Revision:     b4d8d5d170bb4ba516e88d7fe5647e2323d791dd</span><br><span class="line"></span><br><span class="line">Kotlin DSL:   1.0-rc-6</span><br><span class="line">Kotlin:       1.2.61</span><br><span class="line">Groovy:       2.4.15</span><br><span class="line">Ant:          Apache Ant(TM) version 1.9.11 compiled on March 23 2018</span><br><span class="line">JVM:          1.8.0_171 (Oracle Corporation 25.171-b11)</span><br><span class="line">OS:           Windows 10 10.0 amd64</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用gradle将源码转换为eclipse 工程</p>
<p>Spring是分多模块的，所以你要查看哪个模块的源码，就进哪个模块的目录下执行以下命令就可以看到了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle cleanIdea eclipse</span><br></pre></td></tr></table></figure>

<p><strong>可能需要梯子</strong></p>
</li>
<li><p>导入工程,即可食用,注意各个工程之间的依赖</p>
</li>
<li><p>导入后的问题</p>
<p>导入后发现一片红色感叹号，看下sts中的problems的选项框，发现是缺少jar包</p>
<p><code>spring-cglib-repack-3.2.8</code> 和<code>spring-objenesis-repack-3.0.1.jar</code></p>
<p> 我查了下网上大神们的说法：</p>
<p><strong>通过阅读源码发现为了避免第三方 class 的冲突，spring 把最新的 cglib 和 objenesis 给 repack 了</strong></p>
<p>参考链接：</p>
<p>[]: <a href="https://blog.csdn.net/sekiu/article/details/50624180" target="_blank" rel="noopener">https://blog.csdn.net/sekiu/article/details/50624180</a></p>
</li>
</ul>
<h4 id="Spring-Core"><a href="#Spring-Core" class="headerlink" title="Spring-Core"></a>Spring-Core</h4><p>正常的spring启动，是以xml配置bean然后进行启动，web项目由web容器来管理spring容器。</p>
<p>我们在applicationContext.xml中配置好bean后，那么启动时候加载这个xml就可以了。</p>
<h3 id="web容器启动流程"><a href="#web容器启动流程" class="headerlink" title="web容器启动流程"></a>web容器启动流程</h3><p>以web项目为例子 springmvc项目 一般使用web.xml进行管理web容器，而spring容器一般交付给web容器进行管理。</p>
<ul>
<li><p>tomcat 启动，加载context监听器。</p>
<p>首先tomcat的StandardContext类在tomcat启动时候会调用<code>listenerStart</code></p>
<p>去加载配置在web.xml中的监听器</p>
<p>webxml中的配置的spring的ContextLoadListener</p>
<p>ContextLoaderListener 继承自ServletContextListener</p>
<p>嗯，首先加载WebAppRootListener 这个也是继承自ServletContextListener的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;listener&gt;</span><br><span class="line">&lt;listener-class&gt;org.springframework.web.util.WebAppRootListener&lt;/listener-class&gt;</span><br><span class="line">&lt;/listener&gt;</span><br><span class="line">&lt;listener&gt;</span><br><span class="line"> &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;</span><br><span class="line">&lt;/listener&gt;</span><br><span class="line">&lt;listener&gt;</span><br><span class="line">    &lt;listener-class&gt;org.springframework.web.util.IntrospectorCleanupListener&lt;/listener-class&gt;</span><br><span class="line">&lt;/listener&gt;</span><br></pre></td></tr></table></figure>

<p>1.StardandContext中的listenerStart方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line">   * Configure the set of instantiated application event listeners</span><br><span class="line">   * for this Context.</span><br><span class="line">   * @return &lt;code&gt;true&lt;/code&gt; if all listeners wre</span><br><span class="line">   * initialized successfully, or &lt;code&gt;false&lt;/code&gt; otherwise.</span><br><span class="line">   */</span><br><span class="line">  public boolean listenerStart() &#123;</span><br><span class="line">  </span><br><span class="line">      if (log.isDebugEnabled())</span><br><span class="line">          log.debug(&quot;Configuring application event listeners&quot;);</span><br><span class="line">  </span><br><span class="line">      // Instantiate the required listeners</span><br><span class="line">      String listeners[] = findApplicationListeners();</span><br><span class="line">      Object results[] = new Object[listeners.length];</span><br><span class="line">      boolean ok = true;</span><br><span class="line">      for (int i = 0; i &lt; results.length; i++) &#123;</span><br><span class="line">          if (getLogger().isDebugEnabled())</span><br><span class="line">              getLogger().debug(&quot; Configuring event listener class &apos;&quot; +</span><br><span class="line">                  listeners[i] + &quot;&apos;&quot;);</span><br><span class="line">          try &#123;</span><br><span class="line">              String listener = listeners[i];</span><br><span class="line">              results[i] = getInstanceManager().newInstance(listener);</span><br><span class="line">          &#125; catch (Throwable t) &#123;</span><br><span class="line">              t = ExceptionUtils.unwrapInvocationTargetException(t);</span><br><span class="line">              ExceptionUtils.handleThrowable(t);</span><br><span class="line">              getLogger().error(sm.getString(</span><br><span class="line">                      &quot;standardContext.applicationListener&quot;, listeners[i]), t);</span><br><span class="line">              ok = false;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!ok) &#123;</span><br><span class="line">          getLogger().error(sm.getString(&quot;standardContext.applicationSkipped&quot;));</span><br><span class="line">          return false;</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      // Sort listeners in two arrays</span><br><span class="line">      List&lt;Object&gt; eventListeners = new ArrayList&lt;&gt;();</span><br><span class="line">      List&lt;Object&gt; lifecycleListeners = new ArrayList&lt;&gt;();</span><br><span class="line">      for (int i = 0; i &lt; results.length; i++) &#123;</span><br><span class="line">          if ((results[i] instanceof ServletContextAttributeListener)</span><br><span class="line">              || (results[i] instanceof ServletRequestAttributeListener)</span><br><span class="line">              || (results[i] instanceof ServletRequestListener)</span><br><span class="line">              || (results[i] instanceof HttpSessionIdListener)</span><br><span class="line">              || (results[i] instanceof HttpSessionAttributeListener)) &#123;</span><br><span class="line">              eventListeners.add(results[i]);</span><br><span class="line">          &#125;</span><br><span class="line">          if ((results[i] instanceof ServletContextListener)</span><br><span class="line">              || (results[i] instanceof HttpSessionListener)) &#123;</span><br><span class="line">              lifecycleListeners.add(results[i]);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      // Listener instances may have been added directly to this Context by</span><br><span class="line">      // ServletContextInitializers and other code via the pluggability APIs.</span><br><span class="line">      // Put them these listeners after the ones defined in web.xml and/or</span><br><span class="line">      // annotations then overwrite the list of instances with the new, full</span><br><span class="line">      // list.</span><br><span class="line">      for (Object eventListener: getApplicationEventListeners()) &#123;</span><br><span class="line">          eventListeners.add(eventListener);</span><br><span class="line">      &#125;</span><br><span class="line">      setApplicationEventListeners(eventListeners.toArray());</span><br><span class="line">      for (Object lifecycleListener: getApplicationLifecycleListeners()) &#123;</span><br><span class="line">          lifecycleListeners.add(lifecycleListener);</span><br><span class="line">          if (lifecycleListener instanceof ServletContextListener) &#123;</span><br><span class="line">              noPluggabilityListeners.add(lifecycleListener);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      setApplicationLifecycleListeners(lifecycleListeners.toArray());</span><br><span class="line">  </span><br><span class="line">      // Send application start events</span><br><span class="line">  </span><br><span class="line">      if (getLogger().isDebugEnabled())</span><br><span class="line">          getLogger().debug(&quot;Sending application start events&quot;);</span><br><span class="line">  </span><br><span class="line">      // Ensure context is not null</span><br><span class="line">      getServletContext();</span><br><span class="line">      context.setNewServletContextListenerAllowed(false);</span><br><span class="line">  </span><br><span class="line">      Object instances[] = getApplicationLifecycleListeners();</span><br><span class="line">      if (instances == null || instances.length == 0) &#123;</span><br><span class="line">          return ok;</span><br><span class="line">      &#125;</span><br><span class="line">//Spring中经典的事件驱动， 创建一个event</span><br><span class="line">//1.1构建一个事件 内置Context成员变量</span><br><span class="line">      ServletContextEvent event = new ServletContextEvent(getServletContext());</span><br><span class="line">      ServletContextEvent tldEvent = null;</span><br><span class="line">      if (noPluggabilityListeners.size() &gt; 0) &#123;</span><br><span class="line">          noPluggabilityServletContext = new NoPluggabilityServletContext(getServletContext());</span><br><span class="line">          tldEvent = new ServletContextEvent(noPluggabilityServletContext);</span><br><span class="line">      &#125;</span><br><span class="line">      //1.2这里遍历循环 加载所有的继承自ServletContextListener</span><br><span class="line">      for (int i = 0; i &lt; instances.length; i++) &#123;</span><br><span class="line">          if (!(instances[i] instanceof ServletContextListener))</span><br><span class="line">              continue;</span><br><span class="line">          ServletContextListener listener =</span><br><span class="line">              (ServletContextListener) instances[i];</span><br><span class="line">          try &#123;</span><br><span class="line">              fireContainerEvent(&quot;beforeContextInitialized&quot;, listener);</span><br><span class="line">              if (noPluggabilityListeners.contains(listener)) &#123;</span><br><span class="line">              	**//注意这里要加载tldEvent**</span><br><span class="line">                  listener.contextInitialized(tldEvent);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  listener.contextInitialized(event);</span><br><span class="line">              &#125;</span><br><span class="line">              fireContainerEvent(&quot;afterContextInitialized&quot;, listener);</span><br><span class="line">          &#125; catch (Throwable t) &#123;</span><br><span class="line">              ExceptionUtils.handleThrowable(t);</span><br><span class="line">              fireContainerEvent(&quot;afterContextInitialized&quot;, listener);</span><br><span class="line">              getLogger().error</span><br><span class="line">                  (sm.getString(&quot;standardContext.listenerStart&quot;,</span><br><span class="line">                                instances[i].getClass().getName()), t);</span><br><span class="line">              ok = false;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return ok;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>2.那首先加载 WebRootContextListener</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">public class WebAppRootListener implements ServletContextListener &#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public void contextInitialized(ServletContextEvent event) &#123;</span><br><span class="line">		WebUtils.setWebAppRootSystemProperty(event.getServletContext());</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public static void setWebAppRootSystemProperty(ServletContext servletContext) throws IllegalStateException &#123;</span><br><span class="line">	Assert.notNull(servletContext, &quot;ServletContext must not be null&quot;);</span><br><span class="line">	//获得context的根目录</span><br><span class="line">	String root = servletContext.getRealPath(&quot;/&quot;);</span><br><span class="line">	if (root == null) &#123;</span><br><span class="line">		throw new IllegalStateException(</span><br><span class="line">			&quot;Cannot set web app root system property when WAR file is not expanded&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	//WEB_APP_ROOT_KEY_PARAM=webAppRootKey 就是在 web.xml文件中定义的webAppRootKey</span><br><span class="line">	String param = servletContext.getInitParameter(WEB_APP_ROOT_KEY_PARAM);</span><br><span class="line">	//</span><br><span class="line">	String key = (param != null ? param : DEFAULT_WEB_APP_ROOT_KEY);</span><br><span class="line">	String oldValue = System.getProperty(key);</span><br><span class="line">	if (oldValue != null &amp;&amp; !StringUtils.pathEquals(oldValue, root)) &#123;</span><br><span class="line">		throw new IllegalStateException(</span><br><span class="line">			&quot;Web app root system property already set to different value: &apos;&quot; +</span><br><span class="line">			key + &quot;&apos; = [&quot; + oldValue + &quot;] instead of [&quot; + root + &quot;] - &quot; +</span><br><span class="line">			&quot;Choose unique values for the &apos;webAppRootKey&apos; context-param in your web.xml files!&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	//设置系统环境变量</span><br><span class="line">	System.setProperty(key, root);</span><br><span class="line">	servletContext.log(&quot;Set web app root system property: &apos;&quot; + key + &quot;&apos; = [&quot; + root + &quot;]&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.<strong>加载Spring的ContextLoaderListener</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class ContextLoaderListener extends ContextLoader implements ServletContextListener &#123;</span><br><span class="line">...</span><br><span class="line">	@Override</span><br><span class="line">	public void contextInitialized(ServletContextEvent event) &#123;</span><br><span class="line">		//3.1初始化web容器对象</span><br><span class="line">		initWebApplicationContext(event.getServletContext());</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>3.1跳转到ContextLoader进行加载上下文环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">public class ContextLoader &#123;</span><br><span class="line">...</span><br><span class="line">	static &#123;</span><br><span class="line">		// Load default strategy implementations from properties file.</span><br><span class="line">		// This is currently strictly internal and not meant to be customized</span><br><span class="line">		// by application developers.</span><br><span class="line">		try &#123;</span><br><span class="line">			ClassPathResource resource = new ClassPathResource(DEFAULT_STRATEGIES_PATH, ContextLoader.class);</span><br><span class="line">			defaultStrategies = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">		&#125;</span><br><span class="line">		catch (IOException ex) &#123;</span><br><span class="line">			throw new IllegalStateException(&quot;Could not load &apos;ContextLoader.properties&apos;: &quot; + ex.getMessage());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	/**</span><br><span class="line">	 * Initialize Spring&apos;s web application context for the given servlet context,</span><br><span class="line">	 * using the application context provided at construction time, or creating a new one</span><br><span class="line">	 * according to the &quot;&#123;@link #CONTEXT_CLASS_PARAM contextClass&#125;&quot; and</span><br><span class="line">	 * &quot;&#123;@link #CONFIG_LOCATION_PARAM contextConfigLocation&#125;&quot; context-params.</span><br><span class="line">	 * @param servletContext current servlet context</span><br><span class="line">	 * @return the new WebApplicationContext</span><br><span class="line">	 * @see #ContextLoader(WebApplicationContext)</span><br><span class="line">	 * @see #CONTEXT_CLASS_PARAM</span><br><span class="line">	 * @see #CONFIG_LOCATION_PARAM</span><br><span class="line">	 */</span><br><span class="line">	public WebApplicationContext initWebApplicationContext(ServletContext servletContext) &#123;</span><br><span class="line">		if (servletContext.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE) != null) &#123;</span><br><span class="line">			throw new IllegalStateException(</span><br><span class="line">					&quot;Cannot initialize context because there is already a root application context present - &quot; +</span><br><span class="line">					&quot;check whether you have multiple ContextLoader* definitions in your web.xml!&quot;);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Log logger = LogFactory.getLog(ContextLoader.class);</span><br><span class="line">		servletContext.log(&quot;Initializing Spring root WebApplicationContext&quot;);</span><br><span class="line">		if (logger.isInfoEnabled()) &#123;</span><br><span class="line">			logger.info(&quot;Root WebApplicationContext: initialization started&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		//记录初始化时间</span><br><span class="line">		long startTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">		try &#123;</span><br><span class="line">			// Store context in local instance variable, to guarantee that</span><br><span class="line">			// it is available on ServletContext shutdown.</span><br><span class="line">			if (this.context == null) &#123;</span><br><span class="line">			//3.1.1如果上下文环境对象为null，那么实例化一个</span><br><span class="line">				this.context = createWebApplicationContext(servletContext);</span><br><span class="line">			&#125;</span><br><span class="line">			if (this.context instanceof ConfigurableWebApplicationContext) &#123;</span><br><span class="line">				ConfigurableWebApplicationContext cwac = (ConfigurableWebApplicationContext) this.context;</span><br><span class="line">				if (!cwac.isActive()) &#123;</span><br><span class="line">					// The context has not yet been refreshed -&gt; provide services such as</span><br><span class="line">					// setting the parent context, setting the application context id, etc</span><br><span class="line">					if (cwac.getParent() == null) &#123;</span><br><span class="line">						// The context instance was injected without an explicit parent -&gt;</span><br><span class="line">						// determine parent for root web application context, if any.</span><br><span class="line">						//加载父容器</span><br><span class="line">						ApplicationContext parent = loadParentContext(servletContext);</span><br><span class="line">						cwac.setParent(parent);</span><br><span class="line">					&#125;</span><br><span class="line">					//3.1.2配置并刷新web上下文环境</span><br><span class="line">					configureAndRefreshWebApplicationContext(cwac, servletContext);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, this.context);</span><br><span class="line"></span><br><span class="line">			ClassLoader ccl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">			if (ccl == ContextLoader.class.getClassLoader()) &#123;</span><br><span class="line">				currentContext = this.context;</span><br><span class="line">			&#125;</span><br><span class="line">			else if (ccl != null) &#123;</span><br><span class="line">				currentContextPerThread.put(ccl, this.context);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Published root WebApplicationContext as ServletContext attribute with name [&quot; +</span><br><span class="line">						WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE + &quot;]&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			if (logger.isInfoEnabled()) &#123;</span><br><span class="line">				long elapsedTime = System.currentTimeMillis() - startTime;</span><br><span class="line">				logger.info(&quot;Root WebApplicationContext: initialization completed in &quot; + elapsedTime + &quot; ms&quot;);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			return this.context;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (RuntimeException ex) &#123;</span><br><span class="line">			logger.error(&quot;Context initialization failed&quot;, ex);</span><br><span class="line">			servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, ex);</span><br><span class="line">			throw ex;</span><br><span class="line">		&#125;</span><br><span class="line">		catch (Error err) &#123;</span><br><span class="line">			logger.error(&quot;Context initialization failed&quot;, err);</span><br><span class="line">			servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, err);</span><br><span class="line">			throw err;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>3.1.1实例化上下文环境对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protected WebApplicationContext createWebApplicationContext(ServletContext sc) &#123;</span><br><span class="line">//拿到class对象</span><br><span class="line">Class&lt;?&gt; contextClass = determineContextClass(sc);</span><br><span class="line">		if (!ConfigurableWebApplicationContext.class.isAssignableFrom(contextClass)) &#123;</span><br><span class="line">			throw new ApplicationContextException(&quot;Custom context class [&quot; + contextClass.getName() +</span><br><span class="line">					&quot;] is not of type [&quot; + ConfigurableWebApplicationContext.class.getName() + &quot;]&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		//反射生成对象 ConfigurableWebApplicationContext</span><br><span class="line">		return ( ConfigurableWebApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>加载父类容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">public class ContextLoader &#123;</span><br><span class="line">...</span><br><span class="line">	/**</span><br><span class="line">	 * Template method with default implementation (which may be overridden by a</span><br><span class="line">	 * subclass), to load or obtain an ApplicationContext instance which will be</span><br><span class="line">	 * used as the parent context of the root WebApplicationContext. If the</span><br><span class="line">	 * return value from the method is null, no parent context is set.\</span><br><span class="line">	 // 注意下面的话 意思是允许加载多web容器</span><br><span class="line">	 * &lt;p&gt;The main reason to load a parent context here is to allow multiple root</span><br><span class="line">	 * web application contexts to all be children of a shared EAR context, or</span><br><span class="line">	 * alternately to also share the same parent context that is visible to</span><br><span class="line">	 * EJBs. For pure web applications, there is usually no need to worry about</span><br><span class="line">	 * having a parent context to the root web application context.</span><br><span class="line">	 * &lt;p&gt;The default implementation uses</span><br><span class="line">	 * &#123;@link org.springframework.context.access.ContextSingletonBeanFactoryLocator&#125;,</span><br><span class="line">	 * configured via &#123;@link #LOCATOR_FACTORY_SELECTOR_PARAM&#125; and</span><br><span class="line">	 * &#123;@link #LOCATOR_FACTORY_KEY_PARAM&#125;, to load a parent context</span><br><span class="line">	 * which will be shared by all other users of ContextsingletonBeanFactoryLocator</span><br><span class="line">	 * which also use the same configuration parameters.</span><br><span class="line">	 * @param servletContext current servlet context</span><br><span class="line">	 * @return the parent application context, or &#123;@code null&#125; if none</span><br><span class="line">	 * @see org.springframework.context.access.ContextSingletonBeanFactoryLocator</span><br><span class="line">	 */</span><br><span class="line">	protected ApplicationContext loadParentContext(ServletContext servletContext) &#123;</span><br><span class="line">		ApplicationContext parentContext = null;</span><br><span class="line">		String locatorFactorySelector = servletContext.getInitParameter(LOCATOR_FACTORY_SELECTOR_PARAM);</span><br><span class="line">		String parentContextKey = servletContext.getInitParameter(LOCATOR_FACTORY_KEY_PARAM);</span><br><span class="line"></span><br><span class="line">		if (parentContextKey != null) &#123;</span><br><span class="line">			// locatorFactorySelector may be null, indicating the default &quot;classpath*:beanRefContext.xml&quot;</span><br><span class="line">			BeanFactoryLocator locator = ContextSingletonBeanFactoryLocator.getInstance(locatorFactorySelector);</span><br><span class="line">			Log logger = LogFactory.getLog(ContextLoader.class);</span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Getting parent context definition: using parent context key of &apos;&quot; +</span><br><span class="line">						parentContextKey + &quot;&apos; with BeanFactoryLocator&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			this.parentContextRef = locator.useBeanFactory(parentContextKey);</span><br><span class="line">			parentContext = (ApplicationContext) this.parentContextRef.getFactory();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		return parentContext;</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>3.1.2配置并刷新web上下文环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public class ContextLoader &#123;</span><br><span class="line">...</span><br><span class="line">protected void configureAndRefreshWebApplicationContext(ConfigurableWebApplicationContext wac, ServletContext sc) &#123;</span><br><span class="line">		if (ObjectUtils.identityToString(wac).equals(wac.getId())) &#123;</span><br><span class="line">			// The application context id is still set to its original default value</span><br><span class="line">			// -&gt; assign a more useful id based on available information</span><br><span class="line">			String idParam = sc.getInitParameter(CONTEXT_ID_PARAM);</span><br><span class="line">			if (idParam != null) &#123;</span><br><span class="line">				wac.setId(idParam);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				// Generate default id...</span><br><span class="line">				wac.setId(ConfigurableWebApplicationContext.APPLICATION_CONTEXT_ID_PREFIX +</span><br><span class="line">						ObjectUtils.getDisplayString(sc.getContextPath()));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		//设置上下文环境对象</span><br><span class="line">		wac.setServletContext(sc);</span><br><span class="line">		//获取初始化变量</span><br><span class="line">		String configLocationParam = sc.getInitParameter(CONFIG_LOCATION_PARAM);</span><br><span class="line">		if (configLocationParam != null) &#123;</span><br><span class="line">		//设置初始化变量到web容器中</span><br><span class="line">		//设置配置location到web容器这里的configLocationParam 就是web.xml中配置的		     //classpath:xxxxxx.xml</span><br><span class="line">			wac.setConfigLocation(configLocationParam);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// The wac environment&apos;s #initPropertySources will be called in any case when the context</span><br><span class="line">		// is refreshed; do it eagerly here to ensure servlet property sources are in place for</span><br><span class="line">		// use in any post-processing or initialization that occurs below prior to #refresh</span><br><span class="line">		//获取环境对象</span><br><span class="line">		ConfigurableEnvironment env = wac.getEnvironment();</span><br><span class="line">		//3.1.2.1初始化一些配置properties</span><br><span class="line">    	if (env instanceof ConfigurableWebEnvironment) &#123;</span><br><span class="line">			((ConfigurableWebEnvironment) env).initPropertySources(sc, null);</span><br><span class="line">		&#125;</span><br><span class="line">		//3.1.2.2装配上下文环境对象</span><br><span class="line">		customizeContext(sc, wac);</span><br><span class="line">		//3.1.2.3刷新上下文环境</span><br><span class="line">		wac.refresh();</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>3.1.2.1初始化一些配置properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public class StandardServletEnvironment extends StandardEnvironment implements ConfigurableWebEnvironment &#123;</span><br><span class="line">...</span><br><span class="line">	@Override</span><br><span class="line">	public void initPropertySources(ServletContext servletContext, ServletConfig servletConfig) &#123;</span><br><span class="line">		WebApplicationContextUtils.initServletPropertySources(getPropertySources(), servletContext, servletConfig);</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">public abstract class WebApplicationContextUtils &#123;</span><br><span class="line">...</span><br><span class="line">	/**</span><br><span class="line">	 * Replace &#123;@code Servlet&#125;-based &#123;@link StubPropertySource stub property sources&#125; with</span><br><span class="line">	 * actual instances populated with the given &#123;@code servletContext&#125; and</span><br><span class="line">	 * &#123;@code servletConfig&#125; objects.</span><br><span class="line">	 * &lt;p&gt;This method is idempotent with respect to the fact it may be called any number</span><br><span class="line">	 * of times but will perform replacement of stub property sources with their</span><br><span class="line">	 * corresponding actual property sources once and only once.</span><br><span class="line">	 * @param propertySources the &#123;@link MutablePropertySources&#125; to initialize (must not</span><br><span class="line">	 * be &#123;@code null&#125;)</span><br><span class="line">	 * @param servletContext the current &#123;@link ServletContext&#125; (ignored if &#123;@code null&#125;</span><br><span class="line">	 * or if the &#123;@link StandardServletEnvironment#SERVLET_CONTEXT_PROPERTY_SOURCE_NAME</span><br><span class="line">	 * servlet context property source&#125; has already been initialized)</span><br><span class="line">	 * @param servletConfig the current &#123;@link ServletConfig&#125; (ignored if &#123;@code null&#125;</span><br><span class="line">	 * or if the &#123;@link StandardServletEnvironment#SERVLET_CONFIG_PROPERTY_SOURCE_NAME</span><br><span class="line">	 * servlet config property source&#125; has already been initialized)</span><br><span class="line">	 * @see org.springframework.core.env.PropertySource.StubPropertySource</span><br><span class="line">	 * @see org.springframework.core.env.ConfigurableEnvironment#getPropertySources()</span><br><span class="line">	 */</span><br><span class="line">	public static void initServletPropertySources(</span><br><span class="line">			MutablePropertySources propertySources, ServletContext servletContext, ServletConfig servletConfig) &#123;</span><br><span class="line"></span><br><span class="line">		Assert.notNull(propertySources, &quot;&apos;propertySources&apos; must not be null&quot;);</span><br><span class="line">		//propertySources包含这些初始化配置[servletConfigInitParams,servletContextInitParams,jndiProperties,systemProperties,systemEnvironment]</span><br><span class="line">		//SERVLET_CONTEXT_PROPERTY_SOURCE_NAME=servletContextInitParams</span><br><span class="line">		//</span><br><span class="line">		if (servletContext != null &amp;&amp; propertySources.contains(StandardServletEnvironment.SERVLET_CONTEXT_PROPERTY_SOURCE_NAME) &amp;&amp;</span><br><span class="line">				propertySources.get(StandardServletEnvironment.SERVLET_CONTEXT_PROPERTY_SOURCE_NAME) instanceof StubPropertySource) &#123;</span><br><span class="line">			propertySources.replace(StandardServletEnvironment.SERVLET_CONTEXT_PROPERTY_SOURCE_NAME,</span><br><span class="line">					new ServletContextPropertySource(StandardServletEnvironment.SERVLET_CONTEXT_PROPERTY_SOURCE_NAME, servletContext));</span><br><span class="line">		&#125;</span><br><span class="line">		if (servletConfig != null &amp;&amp; propertySources.contains(StandardServletEnvironment.SERVLET_CONFIG_PROPERTY_SOURCE_NAME) &amp;&amp;</span><br><span class="line">				propertySources.get(StandardServletEnvironment.SERVLET_CONFIG_PROPERTY_SOURCE_NAME) instanceof StubPropertySource) &#123;</span><br><span class="line">			propertySources.replace(StandardServletEnvironment.SERVLET_CONFIG_PROPERTY_SOURCE_NAME,</span><br><span class="line">					new ServletConfigPropertySource(StandardServletEnvironment.SERVLET_CONFIG_PROPERTY_SOURCE_NAME, servletConfig));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.1.2.2装配上下文环境对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class ContextLoader &#123;</span><br><span class="line">...</span><br><span class="line">/**</span><br><span class="line">	 * Customize the &#123;@link ConfigurableWebApplicationContext&#125; created by this</span><br><span class="line">	 * ContextLoader after config locations have been supplied to the context</span><br><span class="line">	 * but before the context is &lt;em&gt;refreshed&lt;/em&gt;.</span><br><span class="line">	 * &lt;p&gt;The default implementation &#123;@linkplain #determineContextInitializerClasses(ServletContext)</span><br><span class="line">	 * determines&#125; what (if any) context initializer classes have been specified through</span><br><span class="line">	 * &#123;@linkplain #CONTEXT_INITIALIZER_CLASSES_PARAM context init parameters&#125; and</span><br><span class="line">	 * &#123;@linkplain ApplicationContextInitializer#initialize invokes each&#125; with the</span><br><span class="line">	 * given web application context.</span><br><span class="line">	 * &lt;p&gt;Any &#123;@code ApplicationContextInitializers&#125; implementing</span><br><span class="line">	 * &#123;@link org.springframework.core.Ordered Ordered&#125; or marked with @&#123;@link</span><br><span class="line">	 * org.springframework.core.annotation.Order Order&#125; will be sorted appropriately.</span><br><span class="line">	 * @param sc the current servlet context</span><br><span class="line">	 * @param wac the newly created application context</span><br><span class="line">	 * @see #CONTEXT_INITIALIZER_CLASSES_PARAM</span><br><span class="line">	 * @see ApplicationContextInitializer#initialize(ConfigurableApplicationContext)</span><br><span class="line">	 */</span><br><span class="line">	protected void customizeContext(ServletContext sc, ConfigurableWebApplicationContext wac) &#123;</span><br><span class="line">		List&lt;Class&lt;ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt;&gt;&gt; initializerClasses =</span><br><span class="line">				determineContextInitializerClasses(sc);</span><br><span class="line"></span><br><span class="line">		for (Class&lt;ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt;&gt; initializerClass : initializerClasses) &#123;</span><br><span class="line">			Class&lt;?&gt; initializerContextClass =</span><br><span class="line">					GenericTypeResolver.resolveTypeArgument(initializerClass, ApplicationContextInitializer.class);</span><br><span class="line">			if (initializerContextClass != null &amp;&amp; !initializerContextClass.isInstance(wac)) &#123;</span><br><span class="line">				throw new ApplicationContextException(String.format(</span><br><span class="line">						&quot;Could not apply context initializer [%s] since its generic parameter [%s] &quot; +</span><br><span class="line">						&quot;is not assignable from the type of application context used by this &quot; +</span><br><span class="line">						&quot;context loader: [%s]&quot;, initializerClass.getName(), initializerContextClass.getName(),</span><br><span class="line">						wac.getClass().getName()));</span><br><span class="line">			&#125;</span><br><span class="line">			this.contextInitializers.add(BeanUtils.instantiateClass(initializerClass));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		AnnotationAwareOrderComparator.sort(this.contextInitializers);</span><br><span class="line">		for (ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; initializer : this.contextInitializers) &#123;</span><br><span class="line">			//3.1.2.2.1遍历所有的上下文初始化器，进行初始化容器</span><br><span class="line">			initializer.initialize(wac);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.1.2.2.1遍历所有的上下文初始化器，进行初始化容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public interface ApplicationContextInitializer&lt;C extends ConfigurableApplicationContext&gt; &#123;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * Initialize the given application context.</span><br><span class="line">	 * @param applicationContext the application to configure</span><br><span class="line">	 */</span><br><span class="line">	void initialize(C applicationContext);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.1.2.3刷新上下文环境,这个很重要的一个方法,Spring的bean解析就在这里啊</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractApplicationContext extends DefaultResourceLoader</span><br><span class="line">		implements ConfigurableApplicationContext, DisposableBean &#123;</span><br><span class="line">		...</span><br><span class="line">		@Override</span><br><span class="line">	public void refresh() throws BeansException, IllegalStateException &#123;</span><br><span class="line">		synchronized (this.startupShutdownMonitor) &#123;</span><br><span class="line">			// Prepare this context for refreshing.</span><br><span class="line">			//3.1.2.3.1预备刷新前的一些准备工作</span><br><span class="line">			prepareRefresh();</span><br><span class="line"></span><br><span class="line">			// Tell the subclass to refresh the internal bean factory.</span><br><span class="line">			//3.1.2.3.2告诉父类刷新内置bean工厂</span><br><span class="line">			ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">			// Prepare the bean factory for use in this context.</span><br><span class="line">			//3.1.2.3.3创建bean工厂 主要对bean工厂进行特征设置</span><br><span class="line">			 prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">			try &#123;</span><br><span class="line">				// Allows post-processing of the bean factory in context subclasses.</span><br><span class="line">				//此方法允许子类在所有的 bean 尚未初始化之前注册 BeanPostProcessor</span><br><span class="line">				postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">				// Invoke factory processors registered as beans in the context.</span><br><span class="line">				//BeanFactoryPostProcessor 接口允许我们在 bean 正是初始化之前改变其值。此接口只				//有一个方法</span><br><span class="line">				invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">				// Register bean processors that intercept bean creation.</span><br><span class="line">				//BeanPostProcessors注册 在BeanDefinitions 中查找BeanPostProcessor保存一个				//list中</span><br><span class="line">                registerBeanPostProcessors(beanFactory);</span><br><span class="line">				//支持国际化</span><br><span class="line">				// Initialize message source for this context.</span><br><span class="line">				initMessageSource();</span><br><span class="line">				//加载事件驱动ApplicationEventMulticaster来管理事件驱动三元素 可以看下具体实现</span><br><span class="line">				//有addApplicationListener multicastEvent 传播嘛</span><br><span class="line">				//ApplicationEventPublisher是将事件委托给ApplicationEventMulticaster来处理的</span><br><span class="line">				// Initialize event multicaster for this context.</span><br><span class="line">				initApplicationEventMulticaster();</span><br><span class="line">				//初始化其他的特殊的bean 没有实现方法 默认走的空实现</span><br><span class="line">				// Initialize other special beans in specific context subclasses.</span><br><span class="line">				onRefresh();</span><br><span class="line"></span><br><span class="line">				// Check for listener beans and register them.</span><br><span class="line">				//这里注册监听器了 结合上面的事件广播类进行</span><br><span class="line">				registerListeners();</span><br><span class="line">				//在工厂中进行单例beans的注册配置</span><br><span class="line">				// Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="line">				finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">				// Last step: publish corresponding event.</span><br><span class="line">				finishRefresh();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			catch (BeansException ex) &#123;</span><br><span class="line">				if (logger.isWarnEnabled()) &#123;</span><br><span class="line">					logger.warn(&quot;Exception encountered during context initialization - &quot; +</span><br><span class="line">							&quot;cancelling refresh attempt: &quot; + ex);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				// Destroy already created singletons to avoid dangling resources.</span><br><span class="line">				destroyBeans();</span><br><span class="line"></span><br><span class="line">				// Reset &apos;active&apos; flag.</span><br><span class="line">				cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">				// Propagate exception to caller.</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			finally &#123;</span><br><span class="line">				// Reset common introspection caches in Spring&apos;s core, since we</span><br><span class="line">				// might not ever need metadata for singleton beans anymore...</span><br><span class="line">				resetCommonCaches();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p><strong>finishRefresh</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">protected void finishRefresh() &#123;</span><br><span class="line">	// Initialize lifecycle processor for this context.</span><br><span class="line">	initLifecycleProcessor();</span><br><span class="line">  </span><br><span class="line">	// Propagate refresh to lifecycle processor first.</span><br><span class="line">	getLifecycleProcessor().onRefresh();</span><br><span class="line">  </span><br><span class="line">	// Publish the final event.</span><br><span class="line">	//最后发布上下文构建成功事件</span><br><span class="line">	publishEvent(new ContextRefreshedEvent(this));</span><br><span class="line">	//注册下上下文环境。</span><br><span class="line">	// Participate in LiveBeansView MBean, if active.</span><br><span class="line">	LiveBeansView.registerApplicationContext(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>  finishBeanFactoryInitialization在工厂中进行单例beans的注册配置**</p>
<ul>
<li><p>ConversionService bean类型转换的一个服务bean</p>
</li>
<li><p>StringValueResolver 用于解析注解值</p>
</li>
<li><p>LoadTimeWeaverAware 实现了此接口的 bean 可以得到 LoadTimeWeaver，此处仅仅初始化 </p>
</li>
<li><p>preInstantiateSingletons  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Finish the initialization of this context&apos;s bean factory,</span><br><span class="line"> * initializing all remaining singleton beans.</span><br><span class="line"> */</span><br><span class="line">protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">	// Initialize conversion service for this context.</span><br><span class="line">	if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">			beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">		beanFactory.setConversionService(</span><br><span class="line">				beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	// Register a default embedded value resolver if no bean post-processor</span><br><span class="line">	// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span><br><span class="line">	// at this point, primarily for resolution in annotation attribute values.</span><br><span class="line">	if (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">		beanFactory.addEmbeddedValueResolver(new StringValueResolver() &#123;</span><br><span class="line">			@Override</span><br><span class="line">			public String resolveStringValue(String strVal) &#123;</span><br><span class="line">				return getEnvironment().resolvePlaceholders(strVal);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	// Initialize LoadTimeWeaverAware beans early to allow for registering their transformers early.</span><br><span class="line">	String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false);</span><br><span class="line">	for (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">		getBean(weaverAwareName);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	// Stop using the temporary ClassLoader for type matching.</span><br><span class="line">	beanFactory.setTempClassLoader(null);</span><br><span class="line">  </span><br><span class="line">	// Allow for caching all bean definition metadata, not expecting further changes.</span><br><span class="line">	beanFactory.freezeConfiguration();</span><br><span class="line">  </span><br><span class="line">	// Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="line">	beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><em>preInstantiateSingletons  进行单例bean的预初始化*</em></p>
<p>首先进行单例类的初始化，其中如果 bean 是 FactoryBean 类型 (注意，只定义了 factory-method 属性的普通 bean 并不是 FactoryBean)，并且还是 SmartFactoryBean 类型，那么需要判断是否需要 eagerInit(isEagerInit 是此接口定义的方法)。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">	public void preInstantiateSingletons() throws BeansException &#123;</span><br><span class="line">		if (this.logger.isDebugEnabled()) &#123;</span><br><span class="line">			this.logger.debug(&quot;Pre-instantiating singletons in &quot; + this);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Iterate over a copy to allow for init methods which in turn register new bean definitions.</span><br><span class="line">		// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</span><br><span class="line">		List&lt;String&gt; beanNames = new ArrayList&lt;String&gt;(this.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">		// Trigger initialization of all non-lazy singleton beans...</span><br><span class="line">		for (String beanName : beanNames) &#123;</span><br><span class="line">			RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">			if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">				if (isFactoryBean(beanName)) &#123;</span><br><span class="line">					final FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">					boolean isEagerInit;</span><br><span class="line">					if (System.getSecurityManager() != null &amp;&amp; factory instanceof SmartFactoryBean) &#123;</span><br><span class="line">						isEagerInit = AccessController.doPrivileged(new PrivilegedAction&lt;Boolean&gt;() &#123;</span><br><span class="line">							@Override</span><br><span class="line">							public Boolean run() &#123;</span><br><span class="line">								return ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit();</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;, getAccessControlContext());</span><br><span class="line">					&#125;</span><br><span class="line">					else &#123;</span><br><span class="line">						isEagerInit = (factory instanceof SmartFactoryBean &amp;&amp;</span><br><span class="line">								((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">					&#125;</span><br><span class="line">					if (isEagerInit) &#123;</span><br><span class="line">						getBean(beanName);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					getBean(beanName);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Trigger post-initialization callback for all applicable beans...</span><br><span class="line">		for (String beanName : beanNames) &#123;</span><br><span class="line">			Object singletonInstance = getSingleton(beanName);</span><br><span class="line">			if (singletonInstance instanceof SmartInitializingSingleton) &#123;</span><br><span class="line">				final SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">				if (System.getSecurityManager() != null) &#123;</span><br><span class="line">					AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">						@Override</span><br><span class="line">						public Object run() &#123;</span><br><span class="line">							smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">							return null;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;, getAccessControlContext());</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>  <strong>registerListeners，注册监听器</strong></p>
<p>  需要指出的是监听器列表在ContextLoader类中的<code>initWebApplicationContext</code>方法中的<code>loadParentContext</code>中的<code>useBeanFactory</code>中已经添加进入了</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">public class EventListenerMethodProcessor implements SmartInitializingSingleton, ApplicationContextAware &#123;</span><br><span class="line">...</span><br><span class="line">	protected void processBean(final List&lt;EventListenerFactory&gt; factories, final String beanName, final Class&lt;?&gt; targetType) &#123;</span><br><span class="line">		if (!this.nonAnnotatedClasses.contains(targetType)) &#123;</span><br><span class="line">			Map&lt;Method, EventListener&gt; annotatedMethods = null;</span><br><span class="line">			try &#123;</span><br><span class="line">				annotatedMethods = MethodIntrospector.selectMethods(targetType,</span><br><span class="line">						new MethodIntrospector.MetadataLookup&lt;EventListener&gt;() &#123;</span><br><span class="line">							@Override</span><br><span class="line">							public EventListener inspect(Method method) &#123;</span><br><span class="line">								return AnnotatedElementUtils.findMergedAnnotation(method, EventListener.class);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Throwable ex) &#123;</span><br><span class="line">				// An unresolvable type in a method signature, probably from a lazy bean - let&apos;s ignore it.</span><br><span class="line">				if (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(&quot;Could not resolve methods for bean with name &apos;&quot; + beanName + &quot;&apos;&quot;, ex);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if (CollectionUtils.isEmpty(annotatedMethods)) &#123;</span><br><span class="line">				this.nonAnnotatedClasses.add(targetType);</span><br><span class="line">				if (logger.isTraceEnabled()) &#123;</span><br><span class="line">					logger.trace(&quot;No @EventListener annotations found on bean class: &quot; + targetType.getName());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				// Non-empty set of methods</span><br><span class="line">				for (Method method : annotatedMethods.keySet()) &#123;</span><br><span class="line">					for (EventListenerFactory factory : factories) &#123;</span><br><span class="line">						if (factory.supportsMethod(method)) &#123;</span><br><span class="line">							Method methodToUse = AopUtils.selectInvocableMethod(</span><br><span class="line">									method, this.applicationContext.getType(beanName));</span><br><span class="line">							ApplicationListener&lt;?&gt; applicationListener =</span><br><span class="line">									factory.createApplicationListener(beanName, targetType, methodToUse);</span><br><span class="line">							if (applicationListener instanceof ApplicationListenerMethodAdapter) &#123;</span><br><span class="line">								((ApplicationListenerMethodAdapter) applicationListener)</span><br><span class="line">										.init(this.applicationContext, this.evaluator);</span><br><span class="line">							&#125;</span><br><span class="line">							//注意这里添加applicationListener到环境中了							this.applicationContext.addApplicationListener(applicationListener);</span><br><span class="line">							break;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				if (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(annotatedMethods.size() + &quot; @EventListener methods processed on bean &apos;&quot; +</span><br><span class="line">							beanName + &quot;&apos;: &quot; + annotatedMethods);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  下面是上下文环境中的监听器注册到工厂</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Add beans that implement ApplicationListener as listeners.</span><br><span class="line"> * Doesn&apos;t affect other listeners, which can be added without being beans.</span><br><span class="line"> */</span><br><span class="line">protected void registerListeners() &#123;</span><br><span class="line">	// Register statically specified listeners first.</span><br><span class="line">	//获得到之前加载的监听器列表 监听器列表在configureAndRefreshWebApplicationContext的时候就</span><br><span class="line">	for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">		getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	// Do not initialize FactoryBeans here: We need to leave all regular beans</span><br><span class="line">	// uninitialized to let post-processors apply to them!</span><br><span class="line">	String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, true, false);</span><br><span class="line">	for (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">		getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">	// Publish early application events now that we finally have a multicaster...</span><br><span class="line">	Set&lt;ApplicationEvent&gt; earlyEventsToProcess = this.earlyApplicationEvents;</span><br><span class="line">	this.earlyApplicationEvents = null;</span><br><span class="line">	if (earlyEventsToProcess != null) &#123;</span><br><span class="line">		for (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">			getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>  <strong>initApplicationEventMulticaster</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Initialize the ApplicationEventMulticaster.</span><br><span class="line"> * Uses SimpleApplicationEventMulticaster if none defined in the context.</span><br><span class="line"> * @see org.springframework.context.event.SimpleApplicationEventMulticaster</span><br><span class="line"> */</span><br><span class="line">protected void initApplicationEventMulticaster() &#123;</span><br><span class="line">	ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">	//看工厂中有没有ApplicationEventMulticaster这个类 如果有的话 就取出来</span><br><span class="line">	if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;</span><br><span class="line">		this.applicationEventMulticaster =</span><br><span class="line">				beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);</span><br><span class="line">		if (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(&quot;Using ApplicationEventMulticaster [&quot; + this.applicationEventMulticaster + &quot;]&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">	//如果没有这个类 那么就创建一个 然后作为单例对象放置到工厂中。工厂是在上下文环境对象中包含着的</span><br><span class="line">		this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory);</span><br><span class="line">		beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, this.applicationEventMulticaster);</span><br><span class="line">		if (logger.isDebugEnabled()) &#123;</span><br><span class="line">			logger.debug(&quot;Unable to locate ApplicationEventMulticaster with name &apos;&quot; +</span><br><span class="line">					APPLICATION_EVENT_MULTICASTER_BEAN_NAME +</span><br><span class="line">					&quot;&apos;: using default [&quot; + this.applicationEventMulticaster + &quot;]&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>  <strong>3.1.2.3.1预备刷新前的一些准备工作</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">	 * Prepare this context for refreshing, setting its startup date and</span><br><span class="line">	 * active flag as well as performing any initialization of property sources.</span><br><span class="line">	 */</span><br><span class="line">	protected void prepareRefresh() &#123;</span><br><span class="line">		this.startupDate = System.currentTimeMillis();</span><br><span class="line">		this.closed.set(false);</span><br><span class="line">		this.active.set(true);</span><br><span class="line"></span><br><span class="line">		if (logger.isInfoEnabled()) &#123;</span><br><span class="line">			logger.info(&quot;Refreshing &quot; + this);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Initialize any placeholder property sources in the context environment</span><br><span class="line">		//3.1.2.3.1.1初始化一些配置文件</span><br><span class="line">		initPropertySources();</span><br><span class="line"></span><br><span class="line">		// Validate that all properties marked as required are resolvable</span><br><span class="line">		// see ConfigurablePropertyResolver#setRequiredProperties</span><br><span class="line">		//3.1.2.3.2校验必须的配置</span><br><span class="line">		getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">		// Allow for the collection of early ApplicationEvents,</span><br><span class="line">		// to be published once the multicaster is available...</span><br><span class="line">		this.earlyApplicationEvents = new LinkedHashSet&lt;ApplicationEvent&gt;();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>3.1.2.3.2告诉父类刷新内置bean工厂</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Tell the subclass to refresh the internal bean factory.</span><br><span class="line"> * @return the fresh BeanFactory instance</span><br><span class="line"> * @see #refreshBeanFactory()</span><br><span class="line"> * @see #getBeanFactory()</span><br><span class="line"> */</span><br><span class="line">protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123;</span><br><span class="line">	//3.1.2.3.2.1在这里refresh bean工厂</span><br><span class="line">	refreshBeanFactory();</span><br><span class="line">	ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">	if (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(&quot;Bean factory for &quot; + getDisplayName() + &quot;: &quot; + beanFactory);</span><br><span class="line">	&#125;</span><br><span class="line">	return beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>3.1.2.3.2.1在这里refresh bean工厂</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected final void refreshBeanFactory() throws BeansException &#123;</span><br><span class="line">//如果存在工厂了 就销毁掉 然后关闭工厂 这样就刷新了</span><br><span class="line">	if (hasBeanFactory()) &#123;</span><br><span class="line">		destroyBeans();</span><br><span class="line">		closeBeanFactory();</span><br><span class="line">	&#125;</span><br><span class="line">	try &#123;</span><br><span class="line">		//创建bean可装配到list中的工厂</span><br><span class="line">		DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">		beanFactory.setSerializationId(getId());</span><br><span class="line">		//3.1.2.3.2.1.1给与子类自由定制bean容器的机会</span><br><span class="line">		customizeBeanFactory(beanFactory);</span><br><span class="line">		//3.1.2.3.2.1.2核心的bean加载方法。</span><br><span class="line">		loadBeanDefinitions(beanFactory);</span><br><span class="line">		synchronized (this.beanFactoryMonitor) &#123;</span><br><span class="line">			this.beanFactory = beanFactory;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	catch (IOException ex) &#123;</span><br><span class="line">		throw new ApplicationContextException(&quot;I/O error parsing bean definition source for &quot; + getDisplayName(), ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>3.1.2.3.2.1.1给与子类自由定制bean容器的机会</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">	 * Customize the internal bean factory used by this context.</span><br><span class="line">	 * Called for each &#123;@link #refresh()&#125; attempt.</span><br><span class="line">	 * &lt;p&gt;The default implementation applies this context&apos;s</span><br><span class="line">	 * &#123;@linkplain #setAllowBeanDefinitionOverriding &quot;allowBeanDefinitionOverriding&quot;&#125;</span><br><span class="line">	 * and &#123;@linkplain #setAllowCircularReferences &quot;allowCircularReferences&quot;&#125; settings,</span><br><span class="line">	 * if specified. Can be overridden in subclasses to customize any of</span><br><span class="line">	 * &#123;@link DefaultListableBeanFactory&#125;&apos;s settings.</span><br><span class="line">	 * @param beanFactory the newly created bean factory for this context</span><br><span class="line">	 * @see DefaultListableBeanFactory#setAllowBeanDefinitionOverriding</span><br><span class="line">	 * @see DefaultListableBeanFactory#setAllowCircularReferences</span><br><span class="line">	 * @see DefaultListableBeanFactory#setAllowRawInjectionDespiteWrapping</span><br><span class="line">	 * @see DefaultListableBeanFactory#setAllowEagerClassLoading</span><br><span class="line">	 */</span><br><span class="line">	protected void customizeBeanFactory(DefaultListableBeanFactory beanFactory) &#123;</span><br><span class="line">		if (this.allowBeanDefinitionOverriding != null) &#123;</span><br><span class="line">			//默认false，不允许覆盖beanFactory.setAllowBeanDefinitionOverriding(this.allowBeanDefinitionOverriding);</span><br><span class="line">		&#125;</span><br><span class="line">		if (this.allowCircularReferences != null) &#123;</span><br><span class="line">		//默认false,不允许循环引用</span><br><span class="line">			beanFactory.setAllowCircularReferences(this.allowCircularReferences);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>3.1.2.3.2.1.2核心的bean加载方法。这个方法很重要</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Loads the bean definitions via an XmlBeanDefinitionReader.</span><br><span class="line"> * @see org.springframework.beans.factory.xml.XmlBeanDefinitionReader</span><br><span class="line"> * @see #initBeanDefinitionReader</span><br><span class="line"> * @see #loadBeanDefinitions</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException &#123;</span><br><span class="line">	// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span><br><span class="line">	//创建一个基于xml的bean声明读取器</span><br><span class="line">	XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);</span><br><span class="line">  </span><br><span class="line">	// Configure the bean definition reader with this context&apos;s</span><br><span class="line">	// resource loading environment.</span><br><span class="line">	//设置环境</span><br><span class="line">	beanDefinitionReader.setEnvironment(getEnvironment());</span><br><span class="line">	//设置资源加载器</span><br><span class="line">	beanDefinitionReader.setResourceLoader(this);</span><br><span class="line">	//设置一个资源entity解析器 这里肯定是xml</span><br><span class="line">	beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this));</span><br><span class="line">  </span><br><span class="line">	// Allow a subclass to provide custom initialization of the reader,</span><br><span class="line">	// then proceed with actually loading the bean definitions.</span><br><span class="line">	//3.1.2.3.2.1.2.1初始化bean声明读取器</span><br><span class="line">	initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">	loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>3.1.2.3.2.1.2.1初始化bean声明读取器</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">	public class XmlWebApplicationContext extends AbstractRefreshableWebApplicationContext &#123;</span><br><span class="line">	/**</span><br><span class="line">	 * Load the bean definitions with the given XmlBeanDefinitionReader.</span><br><span class="line">	 * &lt;p&gt;The lifecycle of the bean factory is handled by the refreshBeanFactory method;</span><br><span class="line">	 * therefore this method is just supposed to load and/or register bean definitions.</span><br><span class="line">	 * &lt;p&gt;Delegates to a ResourcePatternResolver for resolving location patterns</span><br><span class="line">	 * into Resource instances.</span><br><span class="line">	 * @throws IOException if the required XML document isn&apos;t found</span><br><span class="line">	 * @see #refreshBeanFactory</span><br><span class="line">	 * @see #getConfigLocations</span><br><span class="line">	 * @see #getResources</span><br><span class="line">	 * @see #getResourcePatternResolver</span><br><span class="line">	 */</span><br><span class="line">	protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws IOException &#123;</span><br><span class="line">		String[] configLocations = getConfigLocations();</span><br><span class="line">		if (configLocations != null) &#123;</span><br><span class="line">			for (String configLocation : configLocations) &#123;</span><br><span class="line">				//读取具体配置位置然后读取器进行加载跳入下面的方法</span><br><span class="line">				reader.loadBeanDefinitions(configLocation);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;	</span><br><span class="line">	public abstract class AbstractBeanDefinitionReader implements EnvironmentCapable, BeanDefinitionReader &#123;</span><br><span class="line"> ...</span><br><span class="line">	/**</span><br><span class="line">	 * Load bean definitions from the specified resource location.</span><br><span class="line">	 * &lt;p&gt;The location can also be a location pattern, provided that the</span><br><span class="line">	 * ResourceLoader of this bean definition reader is a ResourcePatternResolver.</span><br><span class="line">	 * @param location the resource location, to be loaded with the ResourceLoader</span><br><span class="line">	 * (or ResourcePatternResolver) of this bean definition reader</span><br><span class="line">	 * @param actualResources a Set to be filled with the actual Resource objects</span><br><span class="line">	 * that have been resolved during the loading process. May be &#123;@code null&#125;</span><br><span class="line">	 * to indicate that the caller is not interested in those Resource objects.</span><br><span class="line">	 * @return the number of bean definitions found</span><br><span class="line">	 * @throws BeanDefinitionStoreException in case of loading or parsing errors</span><br><span class="line">	 * @see #getResourceLoader()</span><br><span class="line">	 * @see #loadBeanDefinitions(org.springframework.core.io.Resource)</span><br><span class="line">	 * @see #loadBeanDefinitions(org.springframework.core.io.Resource[])</span><br><span class="line">	 */</span><br><span class="line">	public int loadBeanDefinitions(String location, @Nullable Set&lt;Resource&gt; actualResources) throws BeanDefinitionStoreException &#123;</span><br><span class="line">		//开始读取配置了bean的xml文件</span><br><span class="line">		ResourceLoader resourceLoader = getResourceLoader();</span><br><span class="line">		//如果资源加载器不存在的话那么就抛出异常</span><br><span class="line">		if (resourceLoader == null) &#123;</span><br><span class="line">			throw new BeanDefinitionStoreException(</span><br><span class="line">					&quot;Cannot import bean definitions from location [&quot; + location + &quot;]: no ResourceLoader available&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		//如果是classpath：application*.xml这种pattern的话</span><br><span class="line">		if (resourceLoader instanceof ResourcePatternResolver) &#123;</span><br><span class="line">			// Resource pattern matching available.</span><br><span class="line">			try &#123;</span><br><span class="line">			//获得资源</span><br><span class="line">				Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location);</span><br><span class="line">				//遍历循环 获取所有的资源的总数</span><br><span class="line">				int loadCount = loadBeanDefinitions(resources);</span><br><span class="line">				//遍历循环放入actualResources这个set中。</span><br><span class="line">				if (actualResources != null) &#123;</span><br><span class="line">					for (Resource resource : resources) &#123;</span><br><span class="line">						actualResources.add(resource);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				if (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(&quot;Loaded &quot; + loadCount + &quot; bean definitions from location pattern [&quot; + location + &quot;]&quot;);</span><br><span class="line">				&#125;</span><br><span class="line">				return loadCount;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (IOException ex) &#123;</span><br><span class="line">				throw new BeanDefinitionStoreException(</span><br><span class="line">						&quot;Could not resolve bean definition resource pattern [&quot; + location + &quot;]&quot;, ex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;else &#123;</span><br><span class="line">			//否则的话只允许绝对路径的资源配置文件，</span><br><span class="line">			// Can only load single resources by absolute URL.</span><br><span class="line">			Resource resource = resourceLoader.getResource(location);</span><br><span class="line">			//获得资源总数</span><br><span class="line">			int loadCount = loadBeanDefinitions(resource);</span><br><span class="line">			if (actualResources != null) &#123;</span><br><span class="line">				//同样加载到set中</span><br><span class="line">				actualResources.add(resource);</span><br><span class="line">			&#125;</span><br><span class="line">			if (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(&quot;Loaded &quot; + loadCount + &quot; bean definitions from location [&quot; + location + &quot;]&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			return loadCount;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>getResources(location)</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class PathMatchingResourcePatternResolver implements ResourcePatternResolver &#123;</span><br><span class="line">	...</span><br><span class="line">	@Override</span><br><span class="line">	public Resource[] getResources(String locationPattern) throws IOException &#123;</span><br><span class="line">		Assert.notNull(locationPattern, &quot;Location pattern must not be null&quot;);</span><br><span class="line">		//CLASSPATH_ALL_URL_PREFIX=classpath*:</span><br><span class="line">		//如果是以classpath*:开头的</span><br><span class="line">		if (locationPattern.startsWith(CLASSPATH_ALL_URL_PREFIX)) &#123;</span><br><span class="line">			// a class path resource (multiple resources for same name possible)</span><br><span class="line">			//这里的注释的意思是多个资源的partern的话</span><br><span class="line">			if (getPathMatcher().isPattern(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()))) &#123;</span><br><span class="line">				// a class path resource pattern</span><br><span class="line">				//获取匹配的资源列表 返回资源列表</span><br><span class="line">				return findPathMatchingResources(locationPattern);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				// all class path resources with the given name</span><br><span class="line">				return </span><br><span class="line">//获取所有的classpath下的资源			findAllClassPathResources(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			// Generally only look for a pattern after a prefix here,</span><br><span class="line">			// and on Tomcat only after the &quot;*/&quot; separator for its &quot;war:&quot; protocol.</span><br><span class="line">			int prefixEnd = (locationPattern.startsWith(&quot;war:&quot;) ? locationPattern.indexOf(&quot;*/&quot;) + 1 :</span><br><span class="line">					locationPattern.indexOf(&apos;:&apos;) + 1);</span><br><span class="line">			if (getPathMatcher().isPattern(locationPattern.substring(prefixEnd))) &#123;</span><br><span class="line">				// a file pattern</span><br><span class="line">				return findPathMatchingResources(locationPattern);</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				// a single resource with the given name</span><br><span class="line">				return new Resource[] &#123;getResourceLoader().getResource(locationPattern)&#125;;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>findPathMatchingResources,这个找出所有的给定资源匹配模式下的资源列表classpath:*</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">	 * Find all resources that match the given location pattern via the</span><br><span class="line">	 * Ant-style PathMatcher. Supports resources in jar files and zip files</span><br><span class="line">	 * and in the file system.</span><br><span class="line">	 * @param locationPattern the location pattern to match</span><br><span class="line">	 * @return the result as Resource array</span><br><span class="line">	 * @throws IOException in case of I/O errors</span><br><span class="line">	 * @see #doFindPathMatchingJarResources</span><br><span class="line">	 * @see #doFindPathMatchingFileResources</span><br><span class="line">	 * @see org.springframework.util.PathMatcher</span><br><span class="line">	 */</span><br><span class="line">	protected Resource[] findPathMatchingResources(String locationPattern) throws IOException &#123;</span><br><span class="line">		//获取给定location的根目录</span><br><span class="line">		String rootDirPath = determineRootDir(locationPattern);</span><br><span class="line">		String subPattern = locationPattern.substring(rootDirPath.length());</span><br><span class="line">		Resource[] rootDirResources = getResources(rootDirPath);</span><br><span class="line">		Set&lt;Resource&gt; result = new LinkedHashSet&lt;&gt;(16);</span><br><span class="line">		for (Resource rootDirResource : rootDirResources) &#123;</span><br><span class="line">			rootDirResource = resolveRootDirResource(rootDirResource);</span><br><span class="line">			URL rootDirUrl = rootDirResource.getURL();</span><br><span class="line">			if (equinoxResolveMethod != null &amp;&amp; rootDirUrl.getProtocol().startsWith(&quot;bundle&quot;)) &#123;</span><br><span class="line">				URL resolvedUrl = (URL) ReflectionUtils.invokeMethod(equinoxResolveMethod, null, rootDirUrl);</span><br><span class="line">				if (resolvedUrl != null) &#123;</span><br><span class="line">					rootDirUrl = resolvedUrl;</span><br><span class="line">				&#125;</span><br><span class="line">				rootDirResource = new UrlResource(rootDirUrl);</span><br><span class="line">			&#125;</span><br><span class="line">			if (rootDirUrl.getProtocol().startsWith(ResourceUtils.URL_PROTOCOL_VFS)) &#123;</span><br><span class="line">				result.addAll(VfsResourceMatchingDelegate.findMatchingResources(rootDirUrl, subPattern, getPathMatcher()));</span><br><span class="line">			&#125;</span><br><span class="line">			else if (ResourceUtils.isJarURL(rootDirUrl) || isJarResource(rootDirResource)) &#123;</span><br><span class="line">				result.addAll(doFindPathMatchingJarResources(rootDirResource, rootDirUrl, subPattern));</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				result.addAll(doFindPathMatchingFileResources(rootDirResource, subPattern));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		if (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(&quot;Resolved location pattern [&quot; + locationPattern + &quot;] to resources &quot; + result);</span><br><span class="line">		&#125;</span><br><span class="line">		return result.toArray(new Resource[0]);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>findAllClassPathResources，获取所有classpath下的资源</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Find all class location resources with the given location via the ClassLoader.</span><br><span class="line"> * Delegates to &#123;@link #doFindAllClassPathResources(String)&#125;.</span><br><span class="line"> * @param location the absolute path within the classpath</span><br><span class="line"> * @return the result as Resource array</span><br><span class="line"> * @throws IOException in case of I/O errors</span><br><span class="line"> * @see java.lang.ClassLoader#getResources</span><br><span class="line"> * @see #convertClassLoaderURL</span><br><span class="line"> */</span><br><span class="line">protected Resource[] findAllClassPathResources(String location) throws IOException &#123;</span><br><span class="line">	String path = location;</span><br><span class="line">	if (path.startsWith(&quot;/&quot;)) &#123;</span><br><span class="line">		path = path.substring(1);</span><br><span class="line">	&#125;</span><br><span class="line">	Set&lt;Resource&gt; result = doFindAllClassPathResources(path);</span><br><span class="line">	if (logger.isTraceEnabled()) &#123;</span><br><span class="line">		logger.trace(&quot;Resolved classpath location [&quot; + location + &quot;] to resources &quot; + result);</span><br><span class="line">	&#125;</span><br><span class="line">	return result.toArray(new Resource[0]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>  <strong>3.1.2.3.1.1初始化一些配置文件</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AbstractRefreshableWebApplicationContext extends AbstractRefreshableConfigApplicationContext</span><br><span class="line">		implements ConfigurableWebApplicationContext, ThemeSource &#123;</span><br><span class="line">		</span><br><span class="line">		...</span><br><span class="line">			/**</span><br><span class="line">	 * &#123;@inheritDoc&#125;</span><br><span class="line">	 * &lt;p&gt;Replace &#123;@code Servlet&#125;-related property sources.</span><br><span class="line">	 */</span><br><span class="line">	@Override</span><br><span class="line">	protected void initPropertySources() &#123;</span><br><span class="line">	//获得环境对象</span><br><span class="line">		ConfigurableEnvironment env = getEnvironment();</span><br><span class="line">		if (env instanceof ConfigurableWebEnvironment) &#123;</span><br><span class="line">		//加载并初始化配置source</span><br><span class="line">		//又跳到StandardServletEnvironment 进行3.1.2.1初始化一些配置properties</span><br><span class="line">        ((ConfigurableWebEnvironment) env).initPropertySources(this.servletContext, 		this.servletConfig);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">		...</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>   <strong>3.1.2.3.1告诉父类去刷新内置的bean工厂。</strong></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Tell the subclass to refresh the internal bean factory.</span><br><span class="line"> * @return the fresh BeanFactory instance</span><br><span class="line"> * @see #refreshBeanFactory()</span><br><span class="line"> * @see #getBeanFactory()</span><br><span class="line"> */</span><br><span class="line">protected ConfigurableListableBeanFactory obtainFreshBeanFactory() &#123;</span><br><span class="line">	refreshBeanFactory();</span><br><span class="line">	ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">	if (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(&quot;Bean factory for &quot; + getDisplayName() + &quot;: &quot; + beanFactory);</span><br><span class="line">	&#125;</span><br><span class="line">	return beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  <strong>3.1.2.3.3准备bean工厂，包含以下几项:</strong></p>
<ul>
<li><p>BeanExpressionResolver(SpringEL解析器)</p>
</li>
<li><p>PropertyEditorRegistrar 向spring注册Java的PropertyEditor,定义bean的xml里面都是字符串那么由这个东西来转换为我们需要的类型。只有一个实现ResourceEditorRegistrar </p>
</li>
<li><p>设置环境注入 addBeanPostProcessor 这样可以将spring内部的一些对象注入到工厂</p>
</li>
<li><p>依赖解析忽略 ignoreDependencyInterface 指定哪些依赖在注入的时候应该被忽略</p>
</li>
<li><p>bean 伪装 有些对象不在工厂中，但是我们依然想让他被装配到工厂中 那么 registerResolvableDependency 这个装配关系存贮在一个Map&lt;Class&lt;?&gt;,Object&gt;中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">	 * Configure the factory&apos;s standard context characteristics,</span><br><span class="line">	 * such as the context&apos;s ClassLoader and post-processors.</span><br><span class="line">	 * @param beanFactory the BeanFactory to configure</span><br><span class="line">	 */</span><br><span class="line">	protected void prepareBeanFactory(ConfigurableListableBeanFactory beanFactory) &#123;</span><br><span class="line">		// Tell the internal bean factory to use the context&apos;s class loader etc.</span><br><span class="line">		beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">		beanFactory.setBeanExpressionResolver(new StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">		beanFactory.addPropertyEditorRegistrar(new ResourceEditorRegistrar(this, getEnvironment()));</span><br><span class="line"></span><br><span class="line">		// Configure the bean factory with context callbacks.</span><br><span class="line">		beanFactory.addBeanPostProcessor(new ApplicationContextAwareProcessor(this));</span><br><span class="line">		beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">		beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">		beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">		beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">		beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">		beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">		// BeanFactory interface not registered as resolvable type in a plain factory.</span><br><span class="line">		// MessageSource registered (and found for autowiring) as a bean.</span><br><span class="line">		beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">		beanFactory.registerResolvableDependency(ResourceLoader.class, this);</span><br><span class="line">		beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, this);</span><br><span class="line">		beanFactory.registerResolvableDependency(ApplicationContext.class, this);</span><br><span class="line"></span><br><span class="line">		// Register early post-processor for detecting inner beans as ApplicationListeners.</span><br><span class="line">		beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(this));</span><br><span class="line"></span><br><span class="line">		// Detect a LoadTimeWeaver and prepare for weaving, if found.</span><br><span class="line">		if (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">			beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));</span><br><span class="line">			// Set a temporary ClassLoader for type matching.</span><br><span class="line">			beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Register default environment beans.</span><br><span class="line">		//将一些环境变量bean注册为单例对象</span><br><span class="line">		if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">			beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">		&#125;</span><br><span class="line">		if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">			beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">		&#125;</span><br><span class="line">		if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">			beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><em>这样的话SpringCore中关于Spring容器的启动（当然我这里直接是Web容器管理Spring容器）就基本完了回头可以画下流程图 ，普通的Spring容器的启动也是一样的*</em></p>
</li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Spring/" rel="tag"># Spring</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/16/功利主义随想/" rel="next" title="读书随想">
                <i class="fa fa-chevron-left"></i> 读书随想
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/02/Docker（一）/" rel="prev" title="Docker（一）">
                Docker（一） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/p829173265.jpg" alt="Andreby">
          <p class="site-author-name" itemprop="name">Andreby</p>
           
              <p class="site-description motion-element" itemprop="description">如果有什么需要明天做的事 最好现在开始做</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#源码下载"><span class="nav-number">1.</span> <span class="nav-text">源码下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Core"><span class="nav-number">2.</span> <span class="nav-text">Spring-Core</span></a></li></ol><li class="nav-item nav-level-3"><a class="nav-link" href="#web容器启动流程"><span class="nav-number"></span> <span class="nav-text">web容器启动流程</span></a></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Andreby</span>
</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
